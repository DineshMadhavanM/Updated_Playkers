<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Team Setup - PLAYKERS BOOKING</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --cricket-green: #2d5016;
        }
        
        @keyframes flash {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.3); }
        }
        
        .six-flash {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 1000;
            pointer-events: none;
            animation: flash 1.5s ease-out forwards;
            display: none;
        }
        @keyframes flash {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1.3); }
        }
        
        .four-flash {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 1000;
            pointer-events: none;
            animation: flash 1.5s ease-out forwards;
            display: none;
        }
        
        .wicket-flash {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: bold;
            color: #ff4d4d;
            text-shadow: 0 0 20px rgba(255, 77, 77, 0.8);
            z-index: 1000;
            pointer-events: none;
            animation: flash 1.5s ease-out forwards;
            display: none;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
            line-height: 1.6;
            min-height: 100vh;
        }

        .cricket-header {
            background: linear-gradient(135deg, var(--cricket-green) 0%, var(--primary-color) 100%);
            color: white;
            padding: 2.5rem 1rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .cricket-header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .match-id-banner {
            display: none;
            margin-top: 0.25rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            background: rgba(255,255,255,0.15);
            color: #fff;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .setup-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }

        .team-section {
            margin-bottom: 3rem;
        }

        .team-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .player-input input[type="email"],
        .player-input select.player-role {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: white;
            cursor: pointer;
        }
        
        .player-role {
            min-width: 120px;
        }
        
        .player-role option[value="captain"] {
            font-weight: bold;
            color: #1e40af;
        }
        
        .player-role option[value="viceCaptain"] {
            font-weight: 500;
            color: #1e40af;
        }
        
        .player-role option[value="wicketKeeper"] {
            color: #166534;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .players-section {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .player-count {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .player-input {
            display: grid;
            grid-template-columns: 2fr 2fr auto;
            gap: 1rem;
            align-items: end;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            position: relative;
        }

        .player-number {
            position: absolute;
            top: -8px;
            left: 1rem;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            padding: 0.5rem;
        }
        
        /* Match History Styles */
        .match-history-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .match-history-header h2 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .match-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .match-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
            border-color: var(--primary-color);
        }
        
        .match-teams {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        .team-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .team-score {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .vs {
            font-weight: 700;
            color: #64748b;
            margin: 0 1rem;
        }
        
        .match-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .match-result {
            font-weight: 600;
            color: var(--success-color);
            background: #ecfdf5;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .error-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--danger-color);
            background: #fef2f2;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error-message i {
            font-size: 1.25rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .match-list {
                grid-template-columns: 1fr;
            }
            
            .match-card {
                padding: 1.25rem;
            }
            
            .team-name {
                font-size: 0.95rem;
            }
            
            .team-score {
                font-size: 1rem;
            }
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-add-player {
            margin-top: 1rem;
            width: 100%;
            justify-content: center;
            padding: 1rem;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 3rem;
        }

        .validation-message {
            background: var(--danger-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .success-message {
            background: var(--success-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        @media (max-width: 768px) {
            .player-input {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Flash Effects -->
    <div id="sixFlash" class="six-flash">SIX!</div>
    <div id="fourFlash" class="four-flash">FOUR!</div>
    <div id="wicketFlash" class="wicket-flash">WICKET!</div>
    
    <div class="cricket-header">
        <h1><i class="fas fa-users-cog"></i> Cricket Team Setup</h1>
        <p>Configure your teams and players for the match</p>
        <div id="matchIdBanner" class="match-id-banner"></div>
    </div>

    <div class="container">
        <div class="setup-card">
            <h2><i class="fas fa-clipboard-list"></i> Team Setup Phase</h2>
            
            <div class="validation-message" id="validationMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <!-- Team A Section -->
            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-shield-alt"></i> Team A</h3>
                </div>
                
                <div class="form-group">
                    <label for="teamAName">Team A Name *</label>
                    <input type="text" id="teamAName" placeholder="Enter Team A name" required>
                </div>

                <div class="players-section">
                    <div class="players-header">
                        <h4><i class="fas fa-user-friends"></i> Team A Players</h4>
                        <div class="player-count" id="teamACount">0/15 players</div>
                    </div>
                    <p style="margin-bottom: 1rem; color: #64748b;">
                        Minimum 11 players required, maximum 15 allowed. Email addresses are optional.
                    </p>
                    <div id="teamAPlayersList"></div>
                    <button type="button" class="btn btn-success btn-add-player" onclick="addPlayer('A')">
                        <i class="fas fa-plus"></i> Add Player to Team A
                    </button>
                </div>
            </div>

            <!-- Team B Section -->
            <div class="team-section">
                <div class="team-header" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                    <h3><i class="fas fa-shield-alt"></i> Team B</h3>
                </div>
                
                <div class="form-group">
                    <label for="teamBName">Team B Name *</label>
                    <input type="text" id="teamBName" placeholder="Enter Team B name" required>
                </div>

                <div class="players-section">
                    <div class="players-header">
                        <h4><i class="fas fa-user-friends"></i> Team B Players</h4>
                        <div class="player-count" id="teamBCount">0/15 players</div>
                    </div>
                    <p style="margin-bottom: 1rem; color: #64748b;">
                        Minimum 11 players required, maximum 15 allowed. Email addresses are optional.
                    </p>
                    <div id="teamBPlayersList"></div>
                    <button type="button" class="btn btn-success btn-add-player" onclick="addPlayer('B')">
                        <i class="fas fa-plus"></i> Add Player to Team B
                    </button>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="resetTeams()">
                    <i class="fas fa-undo"></i> Reset All Teams
                </button>
                <button type="button" class="btn btn-primary" onclick="validateAndProceed()" id="proceedBtn" disabled>
                    <i class="fas fa-arrow-right"></i> Proceed to Match Configuration
                </button>
            </div>
        </div>

        <!-- Match Configuration Phase -->
        <div id="matchConfigCard" class="setup-card" style="display: none;">
            <h2><i class="fas fa-cog"></i> Match Configuration Phase</h2>
            
            <div class="validation-message" id="configValidationMessage"></div>
            <div class="success-message" id="configSuccessMessage"></div>

            <div class="form-group">
                <label for="totalOvers">Total Overs per Innings (1-50) *</label>
                <input type="number" id="totalOvers" min="1" max="50" value="20" placeholder="Enter total overs (e.g., 20)" required>
                <small style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                    <i class="fas fa-info-circle"></i> Standard formats: T20 (20), ODI (50), Test (unlimited)
                </small>
            </div>

            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-coins"></i> Toss Configuration</h3>
                </div>

                <div class="form-group">
                    <label for="tossWinner">Toss Winner *</label>
                    <select id="tossWinner" required>
                        <option value="">Select which team won the toss</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tossDecision">Toss Decision *</label>
                    <select id="tossDecision" required>
                        <option value="">Select toss decision</option>
                        <option value="bat">Chose to Bat First</option>
                        <option value="bowl">Chose to Bowl First</option>
                    </select>
                </div>
            </div>

            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-play-circle"></i> Opening Players</h3>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">
                            <i class="fas fa-baseball-ball"></i> Opening Batsmen
                        </h4>
                        
                        <div class="form-group">
                            <label for="striker">Striker (On Strike) *</label>
                            <select id="striker" required>
                                <option value="">Select opening striker</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="nonStriker">Non-Striker *</label>
                            <select id="nonStriker" required>
                                <option value="">Select non-striker</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <h4 style="color: #dc2626; margin-bottom: 1rem;">
                            <i class="fas fa-running"></i> Opening Bowler
                        </h4>
                        
                        <div class="form-group">
                            <label for="openingBowler">Opening Bowler *</label>
                            <select id="openingBowler" required>
                                <option value="">Select opening bowler</option>
                            </select>
                        </div>

                        <div style="background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <small style="color: #64748b;">
                                <i class="fas fa-lightbulb"></i> 
                                <strong>Tip:</strong> The opening bowler will bowl the first over of the match.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Match Summary Preview -->
            <div id="matchSummaryPreview" class="team-summary" style="display: none;">
                <h4><i class="fas fa-clipboard-check"></i> Match Configuration Summary</h4>
                <div id="matchSummaryContent"></div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="goBackToTeamSetup()">
                    <i class="fas fa-arrow-left"></i> Back to Team Setup
                </button>
                <button type="button" class="btn btn-success" onclick="startMatch()" id="startMatchBtn" disabled>
                    <i class="fas fa-play"></i> Start Match
                </button>
            </div>
        </div>

        <!-- Live Scoring Phase -->
        <div id="liveScoringCard" class="setup-card" style="display: none;">
            <h2><i class="fas fa-play-circle"></i> Live Cricket Scoring</h2>
            
            <!-- Current Match Status -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="team-score">
                    <h3 id="battingTeamName">Team A</h3>
                    <div class="score-display" id="currentScore">0/0</div>
                    <div id="currentOvers">0.0 overs</div>
                    <div id="runRate">Run Rate: 0.00</div>
                </div>
                <div class="team-score" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                    <h3 id="bowlingTeamName">Team B</h3>
                    <div class="score-display" id="targetInfo">Target: -</div>
                    <div id="requiredInfo">Required: -</div>
                </div>
            </div>

            <!-- Current Players Stats -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="players-section">
                    <h4><i class="fas fa-baseball-ball"></i> Current Batsmen</h4>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Batsman</th>
                                <th>Runs</th>
                                <th>Balls</th>
                                <th>4s</th>
                                <th>6s</th>
                                <th>SR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="strikerName">-</td>
                                <td id="strikerRuns">0</td>
                                <td id="strikerBalls">0</td>
                                <td id="strikerFours">0</td>
                                <td id="strikerSixes">0</td>
                                <td id="strikerSR">0.0</td>
                            </tr>
                            <tr>
                                <td id="nonStrikerName">-</td>
                                <td id="nonStrikerRuns">0</td>
                                <td id="nonStrikerBalls">0</td>
                                <td id="nonStrikerFours">0</td>
                                <td id="nonStrikerSixes">0</td>
                                <td id="nonStrikerSR">0.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="players-section">
                    <h4><i class="fas fa-running"></i> Current Bowler</h4>
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Bowler</th>
                                <th>Overs</th>
                                <th>Runs</th>
                                <th>Wickets</th>
                                <th>Economy</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td id="bowlerName">-</td>
                                <td id="bowlerOvers">0.0</td>
                                <td id="bowlerRuns">0</td>
                                <td id="bowlerWickets">0</td>
                                <td id="bowlerEconomy">0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Partnership Info -->
            <div class="partnership" id="partnershipInfo">
                Partnership: <span id="partnershipRuns">0</span> runs (<span id="partnershipBalls">0</span> balls)
            </div>

            <!-- Extras Tracking Section -->
            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-plus-circle"></i> Extras Breakdown</h3>
                </div>
                <div class="extras-tracking">
                    <div class="extras-grid-display">
                        <div class="extra-box wide-box">
                            <div class="extra-label">
                                <i class="fas fa-arrow-right"></i> Wides
                            </div>
                            <div class="extra-count" id="widesCount">0</div>
                        </div>
                        <div class="extra-box noball-box">
                            <div class="extra-label">
                                <i class="fas fa-exclamation-triangle"></i> No Balls
                            </div>
                            <div class="extra-count" id="noballsCount">0</div>
                        </div>
                        <div class="extra-box legbye-box">
                            <div class="extra-label">
                                <i class="fas fa-running"></i> Leg Byes
                            </div>
                            <div class="extra-count" id="legbyesCount">0</div>
                        </div>
                        <div class="extra-box bye-box">
                            <div class="extra-label">
                                <i class="fas fa-eye-slash"></i> Byes
                            </div>
                            <div class="extra-count" id="byesCount">0</div>
                        </div>
                    </div>
                    <div class="total-extras">
                        <strong>Total Extras: <span id="totalExtras">0</span> runs</strong>
                    </div>
                </div>
            </div>

            <!-- Over Progress -->
            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-clock"></i> Current Over Progress</h3>
                </div>
                <div class="over-progress">
                    <div class="over-progress-bar">
                        <div class="over-progress-fill"></div>
                    </div>
                    <div class="over-info">
                        Ball <span id="ballsInOver">0</span> of 6
                    </div>
                </div>
            </div>

            <!-- Ball-by-Ball Scoring Panel -->
            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-cricket-ball"></i> Ball-by-Ball Scoring</h3>
                </div>

                <div class="scoring-panel">
                    <div class="scoring-row">
                        <button class="score-btn" onclick="addRuns(0)">0</button>
                        <button class="score-btn" onclick="addRuns(1)">1</button>
                        <button class="score-btn" onclick="addRuns(2)">2</button>
                        <button class="score-btn" onclick="addRuns(3)">3</button>
                        <button class="score-btn" onclick="addRuns(4)">4</button>
                        <button class="score-btn" onclick="addRuns(6)">6</button>
                    </div>
                    <div class="extras-row">
                        <div class="extras-dropdown">
                            <button class="score-btn wide" title="Wides" onclick="showWideModal()">Wd+</button>
                        </div>
                        <div class="extras-dropdown">
                            <button class="score-btn noball" title="No Balls" onclick="showNoBallModal()">NB+</button>
                        </div>
                        <div class="extras-dropdown">
                            <button class="score-btn bye" title="Byes" onclick="showByeModal()">B+</button>
                        </div>
                        <div class="extras-dropdown">
                            <button class="score-btn legbye" title="Leg Byes" onclick="showLegByeModal()">LB+</button>
                        </div>
                    </div>
                    
                    <div class="action-row">
                        <button class="score-btn wicket" onclick="showWicketModal()" title="Wicket">W</button>
                        <button class="score-btn extra" onclick="showExtrasModal()" title="More Extras">...</button>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 1rem;">
                    <button class="btn btn-warning" onclick="undoLastBall()" id="undoBtn" disabled>
                        <i class="fas fa-undo"></i> Undo Last Ball
                    </button>
                    <button class="btn btn-primary" onclick="showBowlerChangeModal()" id="changeBowlerBtn" style="display: none;">
                        <i class="fas fa-exchange-alt"></i> Change Bowler
                    </button>
                </div>
            </div>

            <!-- Ball-by-Ball Commentary -->
            <div class="team-section">
                <div class="team-header">
                    <h3><i class="fas fa-comments"></i> Ball-by-Ball Commentary</h3>
                </div>
                <div class="commentary" id="commentaryFeed">
                    <div class="commentary-item">Match ready to start. Good luck to both teams!</div>
                </div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="pauseMatch()" id="pauseBtn">
                    <i class="fas fa-pause"></i> Pause Match
                </button>
                <button type="button" class="btn btn-success" onclick="resumeMatch()" id="resumeBtn" style="display: none;">
                    <i class="fas fa-play"></i> Resume Match
                </button>
                <button type="button" class="btn btn-danger" onclick="endMatch()">
                    <i class="fas fa-stop"></i> End Match
                </button>
            </div>
        </div>
        <!-- Wide Modal -->
        <div id="wideModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeWideModal()">&times;</span>
                <h3><i class="fas fa-exclamation-triangle"></i> Wide Details</h3>
                
                <div class="form-group">
                    <label for="wideType">Wide Type *</label>
                    <select id="wideType" class="form-control" required>
                        <option value="">Select your wide number</option>
                        <optgroup label="Wide Runs">
                            <option value="0">Wide +0 (Total: 1 run)</option>
                            <option value="1">Wide +1 (Total: 2 run)</option>
                            <option value="2">Wide +2 (Total: 3 runs)</option>
                            <option value="3">Wide +3 (Total: 4 runs)</option>
                            <option value="4">Wide +4 (Total: 5 runs)</option>
                            <option value="5">Wide +5 (Total: 6 runs)</option>
                        </optgroup>
                    </select>
                </div>
                
                
                <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeWideModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmWide()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
        
        <!-- No Ball Modal -->
        <div id="noBallModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeNoBallModal()">&times;</span>
                <h3><i class="fas fa-exclamation-circle"></i> No Ball Details</h3>
                
                <div class="form-group">
                    <label for="noBallRuns">Number of Runs *</label>
                    <select id="noBallRuns" class="form-control" required>
                        <option value="">Select number of runs</option>
                        <option value="0">No Ball +0 (Total: 1 run)</option>
                        <option value="1">No Ball +1 (Total: 2 runs)</option>
                        <option value="2">No Ball +2 (Total: 3 runs)</option>
                        <option value="3">No Ball +3 (Total: 4 runs)</option>
                        <option value="4">No Ball +4 (Total: 5 runs)</option>
                        <option value="6">No Ball +6 (Total: 7 runs)</option>
                    </select>
                </div>
                
                <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeNoBallModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmNoBall()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Bye Modal -->
        <div id="byeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeByeModal()">&times;</span>
                <h3><i class="fas fa-running"></i> Bye Details</h3>
                
                <div class="form-group">
                    <label for="byeRuns">Number of Runs *</label>
                    <select id="byeRuns" class="form-control" required>
                        <option value="">Select number of runs</option>
                        <option value="1">1 run</option>
                        <option value="2">2 runs</option>
                        <option value="3">3 runs</option>
                        <option value="4">4 runs</option>
                    </select>
                </div>
                
                <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeByeModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmBye()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Leg Bye Modal -->
        <div id="legByeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeLegByeModal()">&times;</span>
                <h3><i class="fas fa-running"></i> Leg Bye Details</h3>
                
                <div class="form-group">
                    <label for="legByeRuns">Number of Runs *</label>
                    <select id="legByeRuns" class="form-control" required>
                        <option value="">Select number of runs</option>
                        <option value="1">1 run</option>
                        <option value="2">2 runs</option>
                        <option value="3">3 runs</option>
                        <option value="4">4 runs</option>
                    </select>
                </div>
                
                <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeLegByeModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmLegBye()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Wicket Modal -->
        <div id="wicketModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3><i class="fas fa-exclamation-triangle"></i> Wicket Details</h3>
                
                <div class="form-group">
                    <label for="wicketType">Wicket Type *</label>
                    <select id="wicketType" required onchange="updateWicketType()">
                        <option value="">Select wicket type</option>
                        <optgroup label="Standard Dismissals">
                            <option value="bowled">Bowled</option>
                            <option value="caught">Caught</option>
                            <option value="lbw">LBW (Leg Before Wicket)</option>
                            <option value="stumped">Stumped</option>
                            <option value="runout">Run Out</option>
                            <option value="hitwicket">Hit Wicket</option>
                            <option value="wide">Wide Ball + Wicket</option>
                            <option value="noball">No Ball + Wicket</option>
                            <option value="bye">Byes + Wicket</option>
                            <option value="legbye">Leg Byes + Wicket</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Wide Mode Dropdown -->
                
                
                <!-- Runs input for extras with wicket -->
                <div class="form-group" id="wicketExtrasRuns" style="display: none;">
                    <label for="wicketExtrasRunCount">Runs Scored</label>
                    <input type="number" id="wicketExtrasRunCount" min="0" value="0" class="form-control">
                </div>
                

                <div class="form-group" id="fielderGroup" style="display: none;">
                    <label for="fielder">Fielder/Keeper *</label>
                    <select id="fielder">
                        <option value="">Select fielder</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="nextBatsman">Next Batsman *</label>
                    <select id="nextBatsman" required>
                        <option value="">Select next batsman</option>
                    </select>
                </div>

                <!-- Ball-by-Ball Scoring Section -->
                <div class="extras-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <h4><i class="fas fa-cricket"></i> Ball-by-Ball Runs (Optional)</h4>
                    <p class="text-muted" style="font-size: 0.9em; margin-bottom: 10px;">
                        Add any runs scored off this ball before the wicket fell
                    </p>
                    <div class="extras-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(0)">0</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(1)">1</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(2)">2</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(3)">3</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(4)">4</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(5)">5</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(6)">6</button>
                        <button class="extras-btn run" onclick="addRunsBeforeWicket(7)">7+</button>
                    </div>
                    <div id="wicketRunsInfo" style="margin-top: 10px; font-size: 0.9em; color: #666; display: none;">
                        <i class="fas fa-info-circle"></i> <span id="wicketRunsText"></span>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeWicketModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmWicket()">Confirm Wicket</button>
                </div>
            </div>
        </div>

        <!-- Comprehensive Extras Modal -->
        <div id="extrasModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <h3><i class="fas fa-plus-circle"></i> Cricket Extras</h3>
                
                <!-- Wide Balls Section -->
                <div class="extras-section">
                    <h4><i class="fas fa-arrow-right"></i> Wide Balls (+1 auto, not legal delivery)</h4>
                    <div class="extras-grid">
                        <button class="extras-btn wide" onclick="addExtraQuick('wide', 0)">Wide (+0)</button>
                        <button class="extras-btn wide" onclick="addExtraQuick('wide', 1)">Wide (+1)</button>
                        <button class="extras-btn wide" onclick="addExtraQuick('wide', 2)">Wide (+2)</button>
                        <button class="extras-btn wide" onclick="addExtraQuick('wide', 3)">Wide (+3)</button>
                        <button class="extras-btn wide" onclick="addExtraQuick('wide', 4)">Wide (+4)</button>
                    </div>
                </div>

                <!-- No Balls Section -->
                <div class="extras-dropdown">
                            <button class="score-btn noball" title="No Balls" onclick="showNoBallModal()">NB+</button>
                        </div>

                <!-- Leg Byes Section -->
                <div class="extras-section">
                    <h4><i class="fas fa-running"></i> Leg Byes (legal delivery, runs to extras)</h4>
                    <div class="extras-grid">
                        <button class="extras-btn legbye" onclick="addExtraQuick('legbye', 1)">Leg Bye 1</button>
                        <button class="extras-btn legbye" onclick="addExtraQuick('legbye', 2)">Leg Bye 2</button>
                        <button class="extras-btn legbye" onclick="addExtraQuick('legbye', 3)">Leg Bye 3</button>
                        <button class="extras-btn legbye" onclick="addExtraQuick('legbye', 4)">Leg Bye 4</button>
                    </div>
                </div>
                
                <div class="extras-section">
                    <h4>Byes / Leg Byes</h4>
                    <div class="extras-options">
                        <button class="extra-option" onclick="selectExtraOption(this, 'bye', 1)">Byes +1</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'legbye', 1)">Leg Byes +1</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'bye', 2)">Byes +2</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'legbye', 2)">Leg Byes +2</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'bye', 3)">Byes +3</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'legbye', 3)">Leg Byes +3</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'bye', 4)">Byes +4</button>
                        <button class="extra-option" onclick="selectExtraOption(this, 'legbye', 4)">Leg Byes +4</button>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="closeExtrasModal()">Cancel</button>
                    <div class="selected-extra" id="selectedExtraInfo">Select an extra to add</div>
                    <button class="btn-confirm" id="confirmExtraBtn" disabled onclick="confirmExtra()">Add Extra</button>
                </div>
                <script>
                    // Track the currently selected extra
                    let selectedExtra = null;
                    
                    // Function to highlight the scorecard when extras are added
                    function highlightScorecard(elementId) {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.classList.add('highlight');
                            setTimeout(() => {
                                element.classList.remove('highlight');
                            }, 1000);
                        }
                    }
                    
                    // Function to show a notification (e.g., for boundaries)
                    function showNotification(message, type = 'info') {
                        const notification = document.createElement('div');
                        notification.className = `notification ${type}`;
                        notification.textContent = message;
                        
                        // Add to the notifications container or create one if it doesn't exist
                        let container = document.getElementById('notifications');
                        if (!container) {
                            container = document.createElement('div');
                            container.id = 'notifications';
                            container.style.position = 'fixed';
                            container.style.top = '20px';
                            container.style.right = '20px';
                            container.style.zIndex = '9999';
                            document.body.appendChild(container);
                        }
                        
                        container.appendChild(notification);
                        
                        // Auto-remove after 3 seconds
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            notification.style.transform = 'translateX(100%)';
                            setTimeout(() => notification.remove(), 300);
                        }, 3000);
                    }
                </script>
            </div>
        </div>

        <!-- Bowler Change Modal -->
        <div id="bowlerChangeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3><i class="fas fa-exchange-alt"></i> Change Bowler</h3>
                
                <div class="form-group">
                    <label for="newBowler">New Bowler *</label>
                    <select id="newBowler" required>
                        <option value="">Select new bowler</option>
                    </select>
                    <small style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                        <i class="fas fa-info-circle"></i> Same bowler cannot bowl consecutive overs
                    </small>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="closeBowlerChangeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmBowlerChange()">Change Bowler</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .team-score {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .score-display {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0.5rem 0;
        }

        .scoring-panel {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .scoring-row, .extras-row, .action-row {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

            .scoring-panel {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .scoring-row, .extras-row, .action-row {
                display: flex;
                gap: 0.5rem;
                justify-content: center;
                flex-wrap: wrap;
            }

            .scoring-row .score-btn {
                flex: 1;
                min-width: 45px;
            }

            .extras-row {
                gap: 0.25rem;
            }
        .action-row .score-btn {
            flex: 1;
            max-width: 100px;
        }

        .score-btn {
            aspect-ratio: 1;
            border: 2px solid #cbd5e1;
            background: white;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        .score-btn.wicket {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .score-btn.extra {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .commentary {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .commentary-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .commentary-item:last-child {
            border-bottom: none;
        }

        .commentary-time {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .commentary-text {
            color: var(--text-primary);
        }

        .over-progress {
            padding: 1rem;
        }

        .over-progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .over-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .over-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .partnership {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3b82f6 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 600;
        }

        .extras-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .extras-section h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.1em;
            padding-bottom: 5px;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .extras-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .extra-option {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        
        .extra-option:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .extra-option.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
            font-weight: bold;
            
        /* Ball-by-ball scoring buttons in wicket modal */
        .extras-btn.run {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #212529;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        
        .extras-btn.run:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .extras-btn.run:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .extras-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        #wicketRunsInfo {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }
        
        #wicketRunsInfo i {
            color: #ffc107;
            margin-right: 5px;
        }
        
        /* Wicket type dropdown styles */
        #wicketType optgroup {
            font-style: normal;
            font-weight: bold;
            color: #555;
            background-color: #f5f5f5;
        }
        
        #wicketType option {
            padding: 5px 10px;
        }
        
        /* Runs input for wicket extras */
        #wicketExtrasRunCount {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        #wicketExtrasRunCount:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
            outline: none;
        }
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .btn-cancel, .btn-confirm {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-cancel {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-cancel:hover {
            background: #dee2e6;
        }
        
        .btn-confirm {
            background: #28a745;
            color: white;
        }
        
        .btn-confirm:disabled {
            background: #95d5ab;
            cursor: not-allowed;
        }
        
        .btn-confirm:not(:disabled):hover {
            background: #218838;
        }
        
        .selected-extra {
            flex-grow: 1;
            text-align: center;
            color: #495057;
            font-style: italic;
            padding: 0 15px;
        }

        .modal-content h3 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        .modal-content select, .modal-content input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .scoring-panel {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>

    <script>
        let teamData = {
            teamA: { 
                name: '', 
                players: [],
                captain: '',
                viceCaptain: '',
                wicketKeeper: ''
            },
            teamB: { 
                name: '', 
                players: [],
                captain: '',
                viceCaptain: '',
                wicketKeeper: ''
            }
        };

        let matchConfig = {
            overs: 20,
            tossWinner: '',
            tossDecision: '',
            battingFirst: '',
            battingTeam: '',
            bowlingTeam: '',
            striker: '',
            nonStriker: '',
            openingBowler: ''
        };

        let liveMatch = {
            isMatchActive: false,
            innings: 1,
            currentInnings: {
                batting: '',
                bowling: '',
                score: 0,
                wickets: 0,
                overs: 0,
                balls: 0,
                extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 }
            },
            currentBatsmen: {
                striker: { name: '', runs: 0, balls: 0, fours: 0, sixes: 0 },
                nonStriker: { name: '', runs: 0, balls: 0, fours: 0, sixes: 0 }
            },
            currentBowler: { name: '', overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0 },
            partnership: { runs: 0, balls: 0 },
            ballByBall: [],
            lastBall: null,
            lastBallRuns: undefined, // Track runs scored on last legal ball for end-of-over strike rotation
            previousBowler: '',
            playerStats: {},
            bowlerStats: {}
        };

        function initializeLiveMatch() {
            liveMatch = {
                isMatchActive: true,
                innings: 1,
                currentInnings: {
                    batting: matchConfig.battingFirst,
                    bowling: matchConfig.battingFirst === 'A' ? 'B' : 'A',
                    score: 0,
                    wickets: 0,
                    overs: 0,
                    balls: 0,
                    extras: { 
                        wides: 0, noballs: 0, byes: 0, legbyes: 0,
                        widesRuns: 0, noballsRuns: 0, byesRuns: 0, legbyesRuns: 0
                    }
                },
                currentBatsmen: {
                    striker: null,
                    nonStriker: null
                },
                currentBowler: null,
                partnership: { runs: 0, balls: 0 },
                ballByBall: [],
                lastBall: null,
                lastBallRuns: undefined, // Track runs scored on last legal ball for end-of-over strike rotation
                firstInningsScore: 0, // Store first innings score for target calculation
                matchResult: null, // Store final match result
                
                // Enhanced scorecard tracking for both teams and both innings
                scorecards: {
                    teamA: {
                        firstInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } },
                        secondInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } }
                    },
                    teamB: {
                        firstInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } },
                        secondInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } }
                    }
                },
                
                // Separate player stats for each innings
                playerStats: {},
                bowlerStats: {},
                secondInningsPlayerStats: {}, // Team B batting stats for second innings
                secondInningsBowlerStats: {}  // Team A bowling stats for second innings
            };
        }

        // Helper function to get first innings score
        function getFirstInningsScore() {
            if (liveMatch.innings === 1) {
                return liveMatch.currentInnings.score;
            } else {
                return liveMatch.firstInningsScore;
            }
        }

        // Save match data to MongoDB with localStorage fallback
        async function saveMatchData() {
            try {
                // Generate match ID if not exists
                const matchId = matchConfig.matchId || `MATCH-${new Date().toISOString().replace(/[:.]/g, '').slice(0, -5)}`;
                
                // Prepare match data for saving - ensure all fields match the schema
                const matchData = {
                    matchId: matchId,
                    teamA: teamData.teamA,
                    teamB: teamData.teamB,
                    matchConfig: matchConfig,
                    liveMatch: liveMatch,
                    timestamp: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    // Ensure result is a string, not an object
                    result: typeof liveMatch.result === 'object' ? JSON.stringify(liveMatch.result) : (liveMatch.result || '')
                };
                
                // Clean up any circular references that might cause JSON.stringify to fail
                const cleanData = JSON.parse(JSON.stringify(matchData, (key, value) => {
                    // Handle circular references
                    if (typeof value === 'object' && value !== null) {
                        if (key === 'parent' || key === 'document' || key === 'window') {
                            return undefined; // Remove circular references
                        }
                    }
                    return value;
                }));

                // Try to save to MongoDB
                try {
                    const response = await fetch('/api/matches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(cleanData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Match saved to MongoDB:', result);
                    
                    // Update matchId if this is a new match
                    if (result.data && result.data.matchId) {
                        matchConfig.matchId = result.data.matchId;
                        // Update match ID display if it exists
                        const matchIdElement = document.getElementById('matchIdDisplay');
                        if (matchIdElement) {
                            matchIdElement.textContent = `Match ID: ${matchConfig.matchId}`;
                        }
                    }
                } catch (mongoError) {
                    console.error('Error saving to MongoDB, falling back to localStorage:', mongoError);
                }
                
                // Always save to localStorage as a fallback
                try {
                    const allMatches = JSON.parse(localStorage.getItem('cricketMatches') || '[]');
                    const matchIndex = allMatches.findIndex(m => m.matchId === matchData.matchId);
                    
                    if (matchIndex !== -1) {
                        allMatches[matchIndex] = matchData;
                    } else {
                        allMatches.push(matchData);
                    }
                    
                    localStorage.setItem('cricketMatches', JSON.stringify(allMatches));
                    console.log('Match data saved to localStorage');
                } catch (localError) {
                    console.error('Error saving to localStorage:', localError);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error in saveMatchData:', error);
                return false;
            }
        }

        // Load match data from localStorage
        function loadMatchData(matchId) {
            try {
                const allMatches = JSON.parse(localStorage.getItem('cricketMatches') || '[]');
                if (!matchId && allMatches.length > 0) {
                    // If no matchId provided, return the most recent match
                    return allMatches[allMatches.length - 1];
                }
                return allMatches.find(match => match.matchId === matchId) || null;
            } catch (error) {
                console.error('Error loading match data:', error);
                return null;
            }
        }

        // Display match history in the UI
        function displayMatchHistory() {
            try {
                const matchHistoryContainer = document.getElementById('matchHistory');
                if (!matchHistoryContainer) return;
                
                const allMatches = JSON.parse(localStorage.getItem('cricketMatches') || '[]');
                
                if (allMatches.length === 0) {
                    matchHistoryContainer.innerHTML = '<p>No match history found.</p>';
                    return;
                }
                
                let html = `
                    <div class="match-history-header">
                        <h2><i class="fas fa-history"></i> Match History</h2>
                        <p>Showing ${allMatches.length} match${allMatches.length !== 1 ? 'es' : ''}</p>
                    </div>
                    <div class="match-list">
                `;
                
                allMatches.reverse().forEach((match, index) => {
                    const date = new Date(match.date);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div class="match-card" onclick="loadMatch('${match.matchId}')">
                            <div class="match-teams">
                                <div class="team">
                                    <span class="team-name">${match.teamA.name}</span>
                                    <span class="team-score">${match.scorecards.teamA.firstInnings?.score || 0}/${match.scorecards.teamA.firstInnings?.wickets || 0}</span>
                                </div>
                                <div class="vs">vs</div>
                                <div class="team">
                                    <span class="team-name">${match.teamB.name}</span>
                                    <span class="team-score">${match.scorecards.teamB.firstInnings?.score || 0}/${match.scorecards.teamB.firstInnings?.wickets || 0}</span>
                                </div>
                            </div>
                            <div class="match-meta">
                                <span class="match-date">${formattedDate}</span>
                                <span class="match-result">${match.matchResult || 'In Progress'}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>'; // Close match-list
                matchHistoryContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error displaying match history:', error);
                const matchHistoryContainer = document.getElementById('matchHistory');
                if (matchHistoryContainer) {
                    matchHistoryContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error loading match history. Please try again later.</p>
                        </div>
                    `;
                }
            }

            // Update floating live scoreboard box
            try { ensureLiveScoreBox(); updateLiveScoreBox(); } catch {}
        }
        
        // Safe initializer for match history to avoid ReferenceError on DOMContentLoaded
        function initializeMatchHistory() {
            try {
                // Only attempt to render if the container exists on this page/section
                const container = document.getElementById('matchHistory');
                if (container) {
                    displayMatchHistory();
                }
            } catch (err) {
                console.warn('initializeMatchHistory: skipped or failed:', err);
            }
        }
        
        // Load a specific match
        function loadMatch(matchId) {
            const matchData = loadMatchData(matchId);
            if (!matchData) {
                showMessage('Failed to load match data', 'error');
                return;
            }
            
            // Update the UI to show the match
            // This is a simplified version - you'll need to implement the full UI update
            liveMatch = matchData;
            showMatchSummary(matchData.matchResult || 'Match in Progress', matchData.matchStatus || 'in_progress', matchData);
            showDetailedMatchSummaryModal(generateFullScorecard());
        }

        function loadTeamData() {
            try {
                const savedData = localStorage.getItem('cricketTeamData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    teamData = {
                        teamA: {
                            ...parsedData.teamA,
                            players: parsedData.teamA.players || []
                        },
                        teamB: {
                            ...parsedData.teamB,
                            players: parsedData.teamB.players || []
                        }
                    };
                    
                    // Update UI with loaded data
                    document.getElementById('teamAName').value = teamData.teamA.name || '';
                    document.getElementById('teamBName').value = teamData.teamB.name || '';
                    
                    // Clear existing player lists
                    document.getElementById('teamAPlayersList').innerHTML = '';
                    document.getElementById('teamBPlayersList').innerHTML = '';
                    
                    // Rebuild player lists
                    teamData.teamA.players.forEach((_, index) => addPlayer('A', index));
                    teamData.teamB.players.forEach((_, index) => addPlayer('B', index));
                    
                    // Update team counts
                    updateTeamCounts();
                    
                    // Update role selections
                    updateRoleSelections('A');
                    updateRoleSelections('B');
                }
            } catch (error) {
                console.error('Error loading team data:', error);
                // Initialize with default empty data if loading fails
                teamData = {
                    teamA: { name: '', players: [], captain: '', viceCaptain: '', wicketKeeper: '' },
                    teamB: { name: '', players: [], captain: '', viceCaptain: '', wicketKeeper: '' }
                };
            }
            
            // Initialize with default players if no data loaded
            if (teamData.teamA.players.length === 0) {
                initializeTeamSetup();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeMatchHistory();
            loadTeamData(); // Load team data after setting up event listeners
        });

        function initializeTeamSetup() {
            for (let i = 0; i < 11; i++) {
                addPlayer('A');
            }
            for (let i = 0; i < 11; i++) {
                addPlayer('B');
            }
            updateTeamCounts();
        }

        function setupEventListeners() {
            document.getElementById('teamAName').addEventListener('input', function() {
                teamData.teamA.name = this.value.trim();
                checkProceedButton();
            });

            document.getElementById('teamBName').addEventListener('input', function() {
                teamData.teamB.name = this.value.trim();
                checkProceedButton();
            });
        }

        function addPlayer(team) {
            const playersList = document.getElementById(`team${team}PlayersList`);
            const playerCount = playersList.children.length;
            
            if (playerCount >= 15) {
                showMessage('Maximum 15 players allowed per team', 'error');
                return;
            }

            const playerIndex = playerCount + 1;
            const isRequired = playerCount < 11;
            
            const playerDiv = document.createElement('div');
            playerDiv.className = 'player-input';
            playerDiv.innerHTML = `
                <div class="player-number">Player ${playerIndex}</div>
                <input type="text" 
                       placeholder="Player ${playerIndex} Name${isRequired ? ' (Required)' : ''}" 
                       ${isRequired ? 'required' : ''}
                       oninput="updatePlayerData('${team}', ${playerCount}, 'name', this.value); updateRoleSelections('${team}');">
                <input type="email" 
                       placeholder="Email (optional)" 
                       oninput="updatePlayerData('${team}', ${playerCount}, 'email', this.value)">
                <select class="player-role" 
                        onchange="updatePlayerRole('${team}', ${playerCount}, this.value); updateRoleSelections('${team}');">
                    <option value="player">Player</option>
                    <option value="captain">Captain</option>
                    <option value="viceCaptain">Vice Captain</option>
                    <option value="wicketKeeper">Wicket Keeper</option>
                </select>
                <button type="button" 
                        class="btn btn-danger" 
                        onclick="removePlayer(this, '${team}')" 
                        ${isRequired ? 'disabled' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            playersList.appendChild(playerDiv);
            
            if (!teamData[`team${team}`].players[playerCount]) {
                teamData[`team${team}`].players[playerCount] = { name: '', email: '' };
            }
            
            updateTeamCounts();
            checkProceedButton();
        }

        function removePlayer(button, team) {
            const playersList = button.closest('.player-input').parentNode;
            const playerCount = playersList.children.length;
            
            if (playerCount <= 11) {
                showMessage('Minimum 11 players required per team', 'error');
                return;
            }
            
            const playerDiv = button.closest('.player-input');
            const playerIndex = Array.from(playersList.children).indexOf(playerDiv);
            
            playerDiv.remove();
            teamData[`team${team}`].players.splice(playerIndex, 1);
            
            updatePlayerNumbers(team);
            updateTeamCounts();
            checkProceedButton();
        }

        function updatePlayerNumbers(team) {
            const playersList = document.getElementById(`team${team}PlayersList`);
            Array.from(playersList.children).forEach((playerDiv, index) => {
                const playerNumber = playerDiv.querySelector('.player-number');
                const nameInput = playerDiv.querySelector('input[type="text"]');
                const removeBtn = playerDiv.querySelector('.btn-danger');
                
                playerNumber.textContent = `Player ${index + 1}`;
                
                const isRequired = index < 11;
                nameInput.placeholder = `Player ${index + 1} Name${isRequired ? ' (Required)' : ''}`;
                nameInput.required = isRequired;
                removeBtn.disabled = isRequired;
            });
        }

        function updatePlayerData(team, index, field, value) {
            if (!teamData[`team${team}`].players[index]) {
                teamData[`team${team}`].players[index] = { name: '', email: '', role: 'player' };
            }
            
            teamData[`team${team}`].players[index][field] = value.trim();
            checkProceedButton();
        }
        
        function updatePlayerRole(team, index, role) {
            if (!teamData[`team${team}`].players[index]) return;
            
            // Remove this player from any previous role
            const playerName = teamData[`team${team}`].players[index].name;
            const currentRole = teamData[`team${team}`].players[index].role;
            
            // Clear previous role if it was set
            if (currentRole && currentRole !== 'player') {
                teamData[`team${team}`][currentRole] = '';
            }
            
            // Update the player's role
            teamData[`team${team}`].players[index].role = role;
            
            // If assigning a special role, update the team data
            if (role !== 'player') {
                teamData[`team${team}`][role] = playerName;
            }
        }
        
        function updateRoleSelections(team) {
            const playersList = document.getElementById(`team${team}PlayersList`);
            const players = teamData[`team${team}`].players;
            
            // Reset all role selections
            players.forEach((player, index) => {
                const playerDiv = playersList.children[index];
                if (!playerDiv) return;
                
                const roleSelect = playerDiv.querySelector('.player-role');
                if (!roleSelect) return;
                
                // Save current selection
                const currentRole = roleSelect.value;
                
                // Reset options
                roleSelect.innerHTML = `
                    <option value="player">Player</option>
                    <option value="captain">Captain</option>
                    <option value="viceCaptain">Vice Captain</option>
                    <option value="wicketKeeper">Wicket Keeper</option>
                `;
                
                // Restore current selection
                if (currentRole) {
                    roleSelect.value = currentRole;
                }
                
                // Disable already selected roles from other players
                players.forEach((otherPlayer, otherIndex) => {
                    if (index === otherIndex) return;
                    
                    const otherRole = otherPlayer.role;
                    if (otherRole && otherRole !== 'player') {
                        const option = roleSelect.querySelector(`option[value="${otherRole}"]`);
                        if (option) {
                            option.disabled = true;
                            option.textContent += ` (${otherPlayer.name})`;
                        }
                    }
                });
            });
        }

        function updateTeamCounts() {
            const teamACount = document.getElementById('teamAPlayersList').children.length;
            const teamBCount = document.getElementById('teamBPlayersList').children.length;
            
            document.getElementById('teamACount').textContent = `${teamACount}/15 players`;
            document.getElementById('teamBCount').textContent = `${teamBCount}/15 players`;
        }

        function checkProceedButton() {
            const teamAName = teamData.teamA.name;
            const teamBName = teamData.teamB.name;
            
            if (!teamAName || !teamBName) {
                document.getElementById('proceedBtn').disabled = true;
                return;
            }
            
            const teamAValidPlayers = getValidPlayers('A');
            const teamBValidPlayers = getValidPlayers('B');
            
            document.getElementById('proceedBtn').disabled = !(teamAValidPlayers.length >= 11 && teamBValidPlayers.length >= 11);
        }

        function getValidPlayers(team) {
            const playersList = document.getElementById(`team${team}PlayersList`);
            const validPlayers = [];
            
            Array.from(playersList.children).forEach((playerDiv) => {
                const nameInput = playerDiv.querySelector('input[type="text"]');
                const emailInput = playerDiv.querySelector('input[type="email"]');
                
                if (nameInput.value.trim()) {
                    validPlayers.push({
                        name: nameInput.value.trim(),
                        email: emailInput.value.trim() || null
                    });
                }
            });
            
            return validPlayers;
        }

        function validateAndProceed() {
            const teamAName = teamData.teamA.name;
            const teamBName = teamData.teamB.name;
            const teamAPlayers = getValidPlayers('A');
            const teamBPlayers = getValidPlayers('B');
            
            // Validate team names
            if (!teamAName || !teamBName) {
                showMessage('Please enter both team names', 'error');
                return;
            }
            
            if (teamAName === teamBName) {
                showMessage('Team names must be different', 'error');
                return;
            }
            
            // Validate minimum players
            if (teamAPlayers.length < 11) {
                showMessage(`Team A needs at least 11 players (currently ${teamAPlayers.length})`, 'error');
                return;
            }
            
            if (teamBPlayers.length < 11) {
                showMessage(`Team B needs at least 11 players (currently ${teamBPlayers.length})`, 'error');
                return;
            }
            
            // Validate team roles
            const teamARoles = validateTeamRoles('A');
            const teamBRoles = validateTeamRoles('B');
            
            if (!teamARoles.isValid) {
                showMessage(`Team A: ${teamARoles.message}`, 'error');
                return;
            }
            
            if (!teamBRoles.isValid) {
                showMessage(`Team B: ${teamBRoles.message}`, 'error');
                return;
            }
            
            // Update team data with validated players and roles
            teamData.teamA.name = teamAName;
            teamData.teamA.players = teamAPlayers;
            teamData.teamB.name = teamBName;
            teamData.teamB.players = teamBPlayers;
            
            // Store in local storage
            localStorage.setItem('cricketTeamData', JSON.stringify(teamData));
            
            showMessage('Teams configured successfully!', 'success');
            
            setTimeout(() => {
                showMatchConfiguration();
            }, 1000);
        }
        
        function validateTeamRoles(team) {
            const teamObj = teamData[`team${team}`];
            const players = teamObj.players;
            
            // Find players with special roles
            const captain = players.find(p => p.role === 'captain');
            const viceCaptain = players.find(p => p.role === 'viceCaptain');
            const wicketKeeper = players.find(p => p.role === 'wicketKeeper');
            
            // Check for missing roles
            if (!captain) {
                return { isValid: false, message: 'Please select a team captain' };
            }
            
            if (!viceCaptain) {
                return { isValid: false, message: 'Please select a vice-captain' };
            }
            
            if (!wicketKeeper) {
                return { isValid: false, message: 'Please select a wicket-keeper' };
            }
            
            // Update team data with role assignments
            teamObj.captain = captain.name;
            teamObj.viceCaptain = viceCaptain.name;
            teamObj.wicketKeeper = wicketKeeper.name;
            
            return { isValid: true };
        }

        function showMatchConfiguration() {
            // Hide team setup card and show match config card
            document.querySelector('.setup-card').style.display = 'none';
            document.getElementById('matchConfigCard').style.display = 'block';
            
            // Update progress indicator
            updateProgressIndicator('config');
            
            // Setup match configuration dropdowns
            setupMatchConfigDropdowns();
            setupMatchConfigListeners();
            
            showConfigMessage('Team setup complete! Now configure your match settings.', 'success');
        }

        function setupMatchConfigDropdowns() {
            const tossWinner = document.getElementById('tossWinner');
            
            // Clear and populate toss winner options
            tossWinner.innerHTML = `
                <option value="">Select which team won the toss</option>
                <option value="A">${teamData.teamA.name}</option>
                <option value="B">${teamData.teamB.name}</option>
            `;
        }

        function setupMatchConfigListeners() {
            // Total overs listener
            document.getElementById('totalOvers').addEventListener('input', function() {
                matchConfig.overs = parseInt(this.value) || 20;
                checkStartMatchButton();
            });

            // Toss winner listener
            document.getElementById('tossWinner').addEventListener('change', function() {
                matchConfig.tossWinner = this.value;
                assignMatchIdAfterToss();
                updatePlayerDropdowns();
                checkStartMatchButton();
            });

            // Toss decision listener
            document.getElementById('tossDecision').addEventListener('change', function() {
                matchConfig.tossDecision = this.value;
                assignMatchIdAfterToss();
                updatePlayerDropdowns();
                checkStartMatchButton();
            });

            // Player selection listeners
            document.getElementById('striker').addEventListener('change', function() {
                matchConfig.striker = this.value;
                checkStartMatchButton();
            });

            document.getElementById('nonStriker').addEventListener('change', function() {
                matchConfig.nonStriker = this.value;
                checkStartMatchButton();
            });

            document.getElementById('openingBowler').addEventListener('change', function() {
                matchConfig.openingBowler = this.value;
                checkStartMatchButton();
            });
        }

        function updatePlayerDropdowns() {
            const tossWinner = matchConfig.tossWinner;
            const tossDecision = matchConfig.tossDecision;
            
            if (!tossWinner || !tossDecision) {
                clearPlayerDropdowns();
                return;
            }

            // Determine batting and bowling teams
            const battingTeam = (tossDecision === 'bat') ? tossWinner : (tossWinner === 'A' ? 'B' : 'A');
            const bowlingTeam = (battingTeam === 'A') ? 'B' : 'A';
            
            matchConfig.battingTeam = battingTeam;
            matchConfig.bowlingTeam = bowlingTeam;

            // Update batsmen dropdowns
            const striker = document.getElementById('striker');
            const nonStriker = document.getElementById('nonStriker');
            
            striker.innerHTML = '<option value="">Select opening striker</option>';
            nonStriker.innerHTML = '<option value="">Select non-striker</option>';
            
            teamData[`team${battingTeam}`].players.forEach(player => {
                striker.innerHTML += `<option value="${player.name}">${player.name}</option>`;
                nonStriker.innerHTML += `<option value="${player.name}">${player.name}</option>`;
            });

            // Update bowler dropdown
            const openingBowler = document.getElementById('openingBowler');
            openingBowler.innerHTML = '<option value="">Select opening bowler</option>';
            
            teamData[`team${bowlingTeam}`].players.forEach(player => {
                openingBowler.innerHTML += `<option value="${player.name}">${player.name}</option>`;
            });

            // Update team headers to show which team is batting/bowling
            updateTeamHeaders(battingTeam, bowlingTeam);
        }

        function updateTeamHeaders(battingTeam, bowlingTeam) {
            const battingTeamName = teamData[`team${battingTeam}`].name;
            const bowlingTeamName = teamData[`team${bowlingTeam}`].name;
            
            // Update the section headers to show team assignments
            const batsmenHeader = document.querySelector('h4[style*="var(--primary-color)"]');
            const bowlerHeader = document.querySelector('h4[style*="#dc2626"]');
            
            if (batsmenHeader) {
                batsmenHeader.innerHTML = `<i class="fas fa-baseball-ball"></i> Opening Batsmen (${battingTeamName})`;
            }
            
            if (bowlerHeader) {
                bowlerHeader.innerHTML = `<i class="fas fa-running"></i> Opening Bowler (${bowlingTeamName})`;
            }
        }

        function clearPlayerDropdowns() {
            document.getElementById('striker').innerHTML = '<option value="">Select opening striker</option>';
            document.getElementById('nonStriker').innerHTML = '<option value="">Select non-striker</option>';
            document.getElementById('openingBowler').innerHTML = '<option value="">Select opening bowler</option>';
        }

        function checkStartMatchButton() {
            const isValid = matchConfig.overs >= 1 && 
                           matchConfig.overs <= 50 &&
                           matchConfig.tossWinner &&
                           matchConfig.tossDecision &&
                           matchConfig.striker &&
                           matchConfig.nonStriker &&
                           matchConfig.openingBowler &&
                           matchConfig.striker !== matchConfig.nonStriker;

            document.getElementById('startMatchBtn').disabled = !isValid;
            
            if (isValid) {
                updateMatchSummaryPreview();
            } else {
                document.getElementById('matchSummaryPreview').style.display = 'none';
            }
        }

        function updateMatchSummaryPreview() {
            const battingTeamName = teamData[`team${matchConfig.battingTeam}`].name;
            const bowlingTeamName = teamData[`team${matchConfig.bowlingTeam}`].name;
            const tossWinnerName = teamData[`team${matchConfig.tossWinner}`].name;
            
            const summaryContent = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                    <div>
                        <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">Match Format</h5>
                        <p><strong>${matchConfig.overs} overs per innings</strong></p>
                        
                        <h5 style="color: var(--primary-color); margin-bottom: 0.5rem; margin-top: 1rem;">Toss Result</h5>
                        <p><strong>${tossWinnerName}</strong> won the toss and chose to <strong>${matchConfig.tossDecision === 'bat' ? 'bat first' : 'bowl first'}</strong></p>
                    </div>
                    <div>
                        <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">First Innings</h5>
                        <p><strong>Batting:</strong> ${battingTeamName}</p>
                        <p><strong>Bowling:</strong> ${bowlingTeamName}</p>
                        
                        <h5 style="color: var(--primary-color); margin-bottom: 0.5rem; margin-top: 1rem;">Opening Players</h5>
                        <p><strong>Striker:</strong> ${matchConfig.striker}</p>
                        <p><strong>Non-Striker:</strong> ${matchConfig.nonStriker}</p>
                        <p><strong>Opening Bowler:</strong> ${matchConfig.openingBowler}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('matchSummaryContent').innerHTML = summaryContent;
            document.getElementById('matchSummaryPreview').style.display = 'block';
        }

        function goBackToTeamSetup() {
            document.getElementById('matchConfigCard').style.display = 'none';
            document.querySelector('.setup-card').style.display = 'block';
            updateProgressIndicator('team');
        }

        function startMatch() {
            // Validate all match configuration
            if (!validateMatchConfiguration()) {
                return;
            }

            // Ensure matchId exists (fallback if toss listeners didn't assign)
            if (!window.matchId) {
                const mid = generateMatchId();
                window.matchId = mid;
                try { localStorage.setItem('cric_match_id_current', mid); } catch(e) {}
                try { console.log('Fallback assigned Match ID at start:', mid); } catch {}
                updateMatchIdBanner();
            }

            // Save complete match data
            const completeMatchData = {
                teams: teamData,
                config: matchConfig,
                timestamp: new Date().toISOString(),
                matchId: window.matchId || null,
                matchCode: window.matchCode || null
            };
            
            localStorage.setItem('cricketMatchData', JSON.stringify(completeMatchData));
            
            showConfigMessage('Match configuration complete! Starting match...', 'success');
            
            setTimeout(() => {
                startLiveScoring();
            }, 1000);
        }

        function startLiveScoring() {
            // Hide match config and show live scoring
            document.getElementById('matchConfigCard').style.display = 'none';
            document.getElementById('liveScoringCard').style.display = 'block';
            
            // Initialize live match data
            initializeLiveMatch();
            
            // Update all displays
            updateScoreboard();
            updateBatsmenStats();
            updateBowlerStats();
            updatePartnership();
            
            addCommentary(`Match started! ${teamData[`team${matchConfig.battingTeam}`].name} vs ${teamData[`team${matchConfig.bowlingTeam}`].name}`);
            addCommentary(`${matchConfig.striker} and ${matchConfig.nonStriker} are at the crease. ${matchConfig.openingBowler} to bowl the first over.`);
            
            liveMatch.isMatchActive = true;
        }

        function initializeLiveMatch() {
            // Set up current innings
            liveMatch.currentInnings.batting = matchConfig.battingTeam;
            liveMatch.currentInnings.bowling = matchConfig.bowlingTeam;
            
            // Set up current players
            liveMatch.currentBatsmen.striker = {
                name: matchConfig.striker,
                runs: 0, balls: 0, fours: 0, sixes: 0
            };
            liveMatch.currentBatsmen.nonStriker = {
                name: matchConfig.nonStriker,
                runs: 0, balls: 0, fours: 0, sixes: 0
            };
            liveMatch.currentBowler = {
                name: matchConfig.openingBowler,
                overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0
            };
            
            // Initialize player stats
            initializePlayerStats();
            
            // Initialize bowler over tracking for first innings
            liveMatch.maxOversPerBowler = Math.ceil(matchConfig.overs / 5);
            liveMatch.bowlerOverCounts = {};
            
            // Get bowling team data safely
            const bowlingTeam = liveMatch.currentInnings.bowling;
            const bowlingTeamData = bowlingTeam === 'A' ? teamData.teamA : teamData.teamB;
            
            // Initialize over counts for all bowling team players
            bowlingTeamData.players.forEach(player => {
                liveMatch.bowlerOverCounts[player.name] = 0;
            });
        }

        function initializePlayerStats() {
            // Initialize batting stats for all players
            [matchConfig.battingTeam, matchConfig.bowlingTeam].forEach(team => {
                // Get team data safely
                const teamData_safe = team === 'A' ? teamData.teamA : teamData.teamB;
                
                teamData_safe.players.forEach(player => {
                    if (!liveMatch.playerStats[player.name]) {
                        liveMatch.playerStats[player.name] = {
                            runs: 0, balls: 0, fours: 0, sixes: 0, strikeRate: 0,
                            isOut: false, howOut: '', bowlerOut: '', fielderOut: '',
                            team: team
                        };
                    }
                    if (!liveMatch.bowlerStats[player.name]) {
                        liveMatch.bowlerStats[player.name] = {
                            overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0, economy: 0,
                            team: team
                        };
                    }
                });
            });
        }

        // Function to show flash effect
        function showFlash(type) {
            const flash = document.getElementById(type + 'Flash');
            if (flash) {
                flash.style.display = 'block';
                flash.style.animation = 'none';
                // Trigger reflow
                void flash.offsetWidth;
                flash.style.animation = 'flash 1.5s ease-out forwards';
                
                // Hide after animation completes
                setTimeout(() => {
                    flash.style.display = 'none';
                }, 1500);
            }
        }

        // Ball-by-ball scoring functions
        function addRuns(runs) {
            if (!liveMatch.isMatchActive) return;
            
            // Show flash effect for 4 or 6 runs
            if (runs === 4 || runs === 6 ) {
                const flashType = runs === 6 ? 'six' : 'four';
                showFlash(flashType);
                // Broadcast event to tracker
                localStorage.setItem('cricketFlashEvent', JSON.stringify({
                    type: flashType.toUpperCase(),
                    timestamp: Date.now()
                }));
                // Trigger storage event for other tabs
                localStorage.removeItem('cricketFlashEvent');
            }
            
            // Store last ball for undo
            storeLastBall();
            
            // Update scores
            liveMatch.currentInnings.score += runs;
            liveMatch.currentInnings.balls++;
            liveMatch.currentBatsmen.striker.runs += runs;
            liveMatch.currentBatsmen.striker.balls++;
            liveMatch.currentBowler.runs += runs;
            liveMatch.currentBowler.balls++;
            liveMatch.partnership.runs += runs;
            liveMatch.partnership.balls++;
            
            // Update boundaries
            if (runs === 4) {
                liveMatch.currentBatsmen.striker.fours++;
            } else if (runs === 6) {
                liveMatch.currentBatsmen.striker.sixes++;
            }
            
            // Record ball
            recordBall('runs', runs, liveMatch.currentBatsmen.striker.name);
            
            // Add commentary
            addRunsCommentary(runs);
            
            // Store last ball runs for end-of-over strike rotation logic
            liveMatch.lastBallRuns = runs;
            
            // Check for over completion after exactly 6 LEGAL balls
            // AUTHENTIC CRICKET FORMAT:
            // - Start at 0.0, increment to 0.1, 0.2, 0.3, 0.4, 0.5, 0.6
            // - When reaches 0.6  Over complete  Ask for next bowler  Reset to 1.0
            // - Continue: 1.1  1.2  1.3  1.4  1.5  1.6  Complete  2.0
            if (liveMatch.currentInnings.balls % 6 === 0 && liveMatch.currentInnings.balls > 0) {
                // Over completed after exactly 6 legal balls - automatically ask for next bowler
                completeOver();
            } else {
                // Normal strike rotation during over: ODD runs (1,3,5) change strike, EVEN runs (0,2,4,6) keep same strike
                if (runs % 2 === 1) {
                    rotateStrike();
                }
                // Continue current over - update displays
                updateAllDisplays();
            }
            
            // Check for innings completion
            checkInningsCompletion();
            
            // Enable undo button
            document.getElementById('undoBtn').disabled = false;
        }

        // EXTRAS LOGIC (Wide, No-Ball, Byes, Leg-Byes):
        //
        // 1. WIDE BALL (Wd):
        //    - +1 run automatically added to TEAM SCORE.
        //    - Does NOT count as a legal delivery (ball count unchanged).
        //    - Additional runs (0, 1, 2, 3, 4) can be taken by running.
        //    - Example: Wide + 2 runs  3 runs added to TEAM SCORE (all in "Extras").
        //
        // 2. NO BALL (Nb):
        //    - +1 run automatically added to TEAM SCORE.
        //    - Does NOT count as a legal delivery (ball count unchanged).
        //    - Batsman can also score runs off the bat (0, 1, 2, 3, 4, 6).
        //    - Example: No Ball + 4 runs  5 runs added to TEAM SCORE (1 in Extras, 4 in Batsman score).
        //
        // 3. BYES (B):
        //    - Runs taken (1, 2, 3, 4) are added to TEAM SCORE.
        //    - Counts as legal delivery (ball count increases).
        //    - Runs go ONLY to "Extras", NOT to batsman's score.
        //
        // 4. LEG BYES (Lb):
        //    - Runs taken (1, 2, 3, 4) are added to TEAM SCORE.
        //    - Counts as legal delivery (ball count increases).
        //    - Runs go ONLY to "Extras", NOT to batsman's score.
        //
        // 5. SCORING OPTIONS:
        //    - Each extra type allows selecting run values:
        //      Wide:  +0, +1, +2, +3, +4
        //      No Ball: +0, +1, +2, +3, +4, +6
        //      Byes/Leg Byes: +1, +2, +3, +4
        //
        // 6. STRIKE ROTATION WITH EXTRAS:
        //    - Byes & Leg Byes: Strike changes if odd runs are taken.
        //    - Wides & No Balls: Ball count unchanged, strike rotation applies only if runs are run.
        //
        // IMPORTANT: All extras ALWAYS increase the TEAM SCORE, 
        // but only No Ball runs scored off the bat are credited to the batsman.
        
        function addExtra(type, additionalRuns = 0) {
            if (!liveMatch.isMatchActive) return;
            
            storeLastBall();
            
            // AUTHENTIC CRICKET EXTRAS LOGIC IMPLEMENTATION
            let totalRuns = 0;
            let ballCounts = false;
            let runsToExtras = 0;
            let runsToBatsman = 0;
            
            switch(type) {
                case 'wide':
                    // WIDE BALL: +1 run automatically, NOT a legal delivery, additional runs (0-4) by running
                    totalRuns = 1 + additionalRuns;
                    runsToExtras = totalRuns;
                    ballCounts = false; // NOT a legal delivery
                    break;
                    
                case 'noball':
                    // NO BALL: +1 run automatically, NOT a legal delivery, batsman can score (0,1,2,3,4,6)
                    totalRuns = 1 + additionalRuns;
                    runsToExtras = totalRuns; // All runs go to extras tracking for no-ball
                    runsToBatsman = additionalRuns; // Runs scored by batsman (credited separately)
                    ballCounts = false; // NOT a legal delivery
                    break;
                    
                case 'bye':
                    // BYES: Legal delivery, runs (1-4) go to extras, NOT to batsman
                    totalRuns = additionalRuns;
                    runsToExtras = additionalRuns;
                    ballCounts = true; // Legal delivery
                    break;
                    
                case 'legbye':
                    // LEG BYES: Legal delivery, runs (1-4) go to extras, NOT to batsman
                    totalRuns = additionalRuns;
                    runsToExtras = additionalRuns;
                    ballCounts = true; // Legal delivery
                    break;
            }
            
            // CRICKET RULE: ALL EXTRA RUNS ADD TO TEAM SCORE
            // Wide: 1 penalty + additional runs = total added to team score
            // No Ball: 1 penalty + batsman runs = total added to team score  
            // Byes: runs taken by running = added to team score
            // Leg Byes: runs taken by running = added to team score
            liveMatch.currentInnings.score += totalRuns;
            
            // Update extras count (number of times this extra occurred)
            liveMatch.currentInnings.extras[type + 's'] += 1;
            
            // Update extras runs (actual runs scored from this extra type)
            liveMatch.currentInnings.extras[type + 'sRuns'] += runsToExtras;
            
            // Update ball count and batsman stats (only for legal deliveries)
            if (ballCounts) {
                liveMatch.currentInnings.balls++;
                liveMatch.currentBatsmen.striker.balls++;
                liveMatch.currentBowler.balls++;
            }
            
            // Update batsman runs (only for no-balls where batsman actually scored)
            if (runsToBatsman > 0) {
                liveMatch.currentBatsmen.striker.runs += runsToBatsman;
                // Update boundaries for batsman
                if (runsToBatsman === 4) {
                    liveMatch.currentBatsmen.striker.fours++;
                } else if (runsToBatsman === 6) {
                    liveMatch.currentBatsmen.striker.sixes++;
                }
            }
            
            // Update bowler stats (authentic rules)
            // - Wides: charge all wide runs to bowler (penalty + any run(s) run)
            // - No-balls: charge penalty (1) + only batsman runs to bowler
            // - Byes/Leg Byes: do NOT add to bowler's runs
            if (type === 'wide') {
                liveMatch.currentBowler.runs += totalRuns;
            } else if (type === 'noball') {
                liveMatch.currentBowler.runs += (1 + runsToBatsman);
            } else {
                // bye / legbye -> no change to bowler runs
            }
            
            // Update partnership
            liveMatch.partnership.runs += totalRuns;
            liveMatch.partnership.balls += ballCounts ? 1 : 0;
            
            // Record ball
            recordBall('extra', totalRuns, liveMatch.currentBatsmen.striker.name, type);
            
            // Add commentary
            addExtraCommentary(type, totalRuns, additionalRuns);
            
            // AUTHENTIC STRIKE ROTATION RULES WITH EXTRAS:
            if (type === 'bye' || type === 'legbye') {
                // Byes & Leg Byes: Strike changes if odd runs are taken
                if (additionalRuns % 2 === 1) {
                    rotateStrike();
                }
                // Store last ball runs for end-of-over logic
                liveMatch.lastBallRuns = additionalRuns;
            } else if (type === 'wide' || type === 'noball') {
                // Wides & No Balls: Strike rotation only if runs are run (additional runs > 0)
                if (additionalRuns > 0 && additionalRuns % 2 === 1) {
                    rotateStrike();
                }
                // Don't store last ball runs for wides/no-balls as they don't count toward over completion
            }
            
            // Check for over completion (only for legal deliveries)
            if (ballCounts && liveMatch.currentInnings.balls === 6) {
                completeOver();
            } else {
                updateAllDisplays();
            }
            
            checkInningsCompletion();
            document.getElementById('undoBtn').disabled = false;
        }

        // Quick extras function for direct button clicks with validation
        function addExtraQuick(type, runs) {
            if (!liveMatch.isMatchActive) return;
            
            // Validate runs based on extra type
            switch(type) {
                case 'wide':
                    if (runs < 0 || runs > 4) {
                        alert('Wide runs must be between 0 and 4');
                        return;
                    }
                    break;
                case 'noball':
                    if (runs < 0 || (runs > 6 && runs !== 0) || runs === 5) {
                        alert('No ball runs must be 0, 1, 2, 3, 4, or 6');
                        return;
                    }
                    break;
                case 'bye':
                case 'legbye':
                    if (runs < 1 || runs > 4) {
                        alert('Byes/Leg Byes must be between 1 and 4');
                        return;
                    }
                    break;
            }
            
            addExtra(type, runs);
            closeExtrasModal();
        }

        // Show extras modal with proper state
        function showExtrasModal() {
            if (!liveMatch.isMatchActive) return;
            
            // Reset any previous selections
            const modal = document.getElementById('extrasModal');
            const buttons = modal.querySelectorAll('.extra-option');
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            // Show the modal
            modal.style.display = 'flex';
            
            // Update UI based on match state
            updateExtrasModalUI();
        }
        
        // Update extras modal UI based on current match state
        function updateExtrasModalUI() {
            // Update team names and scores in the modal
            const battingTeam = liveMatch.currentInnings.team;
            const bowlingTeam = liveMatch.currentInnings.team === liveMatch.teamA.name ? 
                liveMatch.teamB.name : liveMatch.teamA.name;
                
            document.getElementById('extrasBattingTeam').textContent = battingTeam;
            document.getElementById('extrasBowlingTeam').textContent = bowlingTeam;
            document.getElementById('extrasCurrentScore').textContent = 
                `${liveMatch.currentInnings.score}/${liveMatch.currentInnings.wickets}`;
            document.getElementById('extrasOvers').textContent = 
                formatOvers(liveMatch.currentInnings.balls);
        }

        // Close extras modal
        function closeExtrasModal() {
            document.getElementById('extrasModal').style.display = 'none';
        }

        function addWicket(wicketType, nextBatsman, fielder = '') {
            if (!liveMatch.isMatchActive) return;
            
            // Store last ball for undo
            storeLastBall();
            
            // Add wicket to current bowler
            const bowler = liveMatch.currentBowler;
            if (bowler) {
                if (!bowler.wickets) bowler.wickets = 0;
                bowler.wickets++;
            }
            
            // Add wicket to current batsman
            const batsman = liveMatch.currentBatsman;
            if (batsman) {
                if (!batsman.out) {
                    batsman.out = true;
                    batsman.dismissal = wicketType;
                    batsman.fielder = fielder || '';
                    batsman.bowler = bowler ? bowler.name : '';
                    addWicketCommentary(wicketType, batsman.name, fielder);
                    
                    // Show wicket flash animation
            showFlash('wicket');
            
            // Broadcast WICKET event to tracker
            localStorage.setItem('cricketFlashEvent', JSON.stringify({
                type: 'WICKET',
                batsman: batsman.name,
                timestamp: Date.now()
            }));
            // Trigger storage event for other tabs
            localStorage.removeItem('cricketFlashEvent');
                }
            }
            
            // Update team stats
            liveMatch.wickets++;
            liveMatch.teamStats[liveMatch.battingTeam].wickets++;
            
            // Check if all out or innings complete
            checkInningsCompletion();
            
            // Update all displays
            updateAllDisplays();
            
            // Save match data
            saveMatchData();
        }
        
        //    - +1 run automatically added to TEAM SCORE.
        //    - Does NOT count as a legal delivery (ball count unchanged).
        //    - Batsman can also score runs off the bat (0, 1, 2, 3, 4, 6).
        //    - Example: No Ball + 4 runs  5 runs added to TEAM SCORE (1 in Extras, 4 in Batsman score).
        //
        // 3. BYES (B):
        //    - Runs taken (1, 2, 3, 4) are added to TEAM SCORE.
        //    - Counts as legal delivery (ball count increases).
        //    - Runs go ONLY to "Extras", NOT to batsman's score.
        //
        // 4. LEG BYES (Lb):
        //    - Runs taken (1, 2, 3, 4) are added to TEAM SCORE.
        //    - Counts as legal delivery (ball count increases).
        //    - Runs go ONLY to "Extras", NOT to batsman's score.
        //
        // 5. SCORING OPTIONS:
        //    - Each extra type allows selecting run values:
        //      Wide:  +0, +1, +2, +3, +4
        //      No Ball: +0, +1, +2, +3, +4, +6
        //      Byes/Leg Byes: +1, +2, +3, +4
        //
        // 6. STRIKE ROTATION WITH EXTRAS:
        //    - Byes & Leg Byes: Strike changes if odd runs are taken.
        //    - Wides & No Balls: Ball count unchanged, strike rotation applies only if runs are run.
        //
        // IMPORTANT: All extras ALWAYS increase the TEAM SCORE, 
        // but only No Ball runs scored off the bat are credited to the batsman.
        
        function addExtra(type, additionalRuns = 0) {
            if (!liveMatch.isMatchActive) return;
            
            storeLastBall();
            
            // AUTHENTIC CRICKET EXTRAS LOGIC IMPLEMENTATION
            let totalRuns = 0;
            let ballCounts = false;
            let runsToExtras = 0;
            let runsToBatsman = 0;
            
            switch(type) {
                case 'wide':
                    // WIDE BALL: +1 run automatically, NOT a legal delivery, additional runs (0-4) by running
                    totalRuns = 1 + additionalRuns;
                    runsToExtras = totalRuns;
                    ballCounts = false; // NOT a legal delivery
                    break;
                    
                case 'noball':
                    // NO BALL: +1 run automatically, NOT a legal delivery, batsman can score (0,1,2,3,4,6)
                    totalRuns = 1 + additionalRuns;
                    runsToExtras = totalRuns; // All runs go to extras tracking for no-ball
                    runsToBatsman = additionalRuns; // Runs scored by batsman (credited separately)
                    ballCounts = false; // NOT a legal delivery
                    break;
                    
                case 'bye':
                    // BYES: Legal delivery, runs (1-4) go to extras, NOT to batsman
                    totalRuns = additionalRuns;
                    runsToExtras = additionalRuns;
                    ballCounts = true; // Legal delivery
                    break;
                    
                case 'legbye':
                    // LEG BYES: Legal delivery, runs (1-4) go to extras, NOT to batsman
                    totalRuns = additionalRuns;
                    runsToExtras = additionalRuns;
                    ballCounts = true; // Legal delivery
                    break;
            }
            
            // CRICKET RULE: ALL EXTRA RUNS ADD TO TEAM SCORE
            // Wide: 1 penalty + additional runs = total added to team score
            // No Ball: 1 penalty + batsman runs = total added to team score  
            // Byes: runs taken by running = added to team score
            // Leg Byes: runs taken by running = added to team score
            liveMatch.currentInnings.score += totalRuns;
            
            // Update extras count (number of times this extra occurred)
            liveMatch.currentInnings.extras[type + 's'] += 1;
            
            // Update extras runs (actual runs scored from this extra type)
            liveMatch.currentInnings.extras[type + 'sRuns'] += runsToExtras;
            
            // Update ball count and batsman stats (only for legal deliveries)
            if (ballCounts) {
                liveMatch.currentInnings.balls++;
                liveMatch.currentBatsmen.striker.balls++;
                liveMatch.currentBowler.balls++;
            }
            
            // Update batsman runs (only for no-balls where batsman actually scored)
            if (runsToBatsman > 0) {
                liveMatch.currentBatsmen.striker.runs += runsToBatsman;
                // Update boundaries for batsman
                if (runsToBatsman === 4) {
                    liveMatch.currentBatsmen.striker.fours++;
                } else if (runsToBatsman === 6) {
                    liveMatch.currentBatsmen.striker.sixes++;
                }
            }
            
            // Update bowler stats (authentic rules)
            // - Wides: charge all wide runs to bowler (penalty + any run(s) run)
            // - No-balls: charge penalty (1) + only batsman runs to bowler
            // - Byes/Leg Byes: do NOT add to bowler's runs
            if (type === 'wide') {
                liveMatch.currentBowler.runs += totalRuns;
            } else if (type === 'noball') {
                liveMatch.currentBowler.runs += (1 + runsToBatsman);
            } else {
                // bye / legbye -> no change to bowler runs
            }
            
            // Update partnership
            liveMatch.partnership.runs += totalRuns;
            liveMatch.partnership.balls += ballCounts ? 1 : 0;
            
            // Record ball
            recordBall('extra', totalRuns, liveMatch.currentBatsmen.striker.name, type);
            
            // Add commentary
            addExtraCommentary(type, totalRuns, additionalRuns);
            
            // AUTHENTIC STRIKE ROTATION RULES WITH EXTRAS:
            if (type === 'bye' || type === 'legbye') {
                // Byes & Leg Byes: Strike changes if odd runs are taken
                if (additionalRuns % 2 === 1) {
                    rotateStrike();
                }
                // Store last ball runs for end-of-over logic
                liveMatch.lastBallRuns = additionalRuns;
            } else if (type === 'wide' || type === 'noball') {
                // Wides & No Balls: Strike rotation only if runs are run (additional runs > 0)
                if (additionalRuns > 0 && additionalRuns % 2 === 1) {
                    rotateStrike();
                }
                // Don't store last ball runs for wides/no-balls as they don't count toward over completion
            }
            
            // Check for over completion (only for legal deliveries)
            if (ballCounts && liveMatch.currentInnings.balls === 6) {
                completeOver();
            } else {
                updateAllDisplays();
            }
            
            checkInningsCompletion();
            document.getElementById('undoBtn').disabled = false;
        }

        // Quick extras function for direct button clicks with validation
        function addExtraQuick(type, runs) {
            if (!liveMatch.isMatchActive) return;
            
            // Validate runs based on extra type
            switch(type) {
                case 'wide':
                    if (runs < 0 || runs > 4) {
                        alert('Wide runs must be between 0 and 4');
                        return;
                    }
                    break;
                case 'noball':
                    if (runs < 0 || (runs > 6 && runs !== 0) || runs === 5) {
                        alert('No ball runs must be 0, 1, 2, 3, 4, or 6');
                        return;
                    }
                    break;
                case 'bye':
                case 'legbye':
                    if (runs < 1 || runs > 4) {
                        alert('Byes/Leg Byes must be between 1 and 4');
                        return;
                    }
                    break;
            }
            
            addExtra(type, runs);
            closeExtrasModal();
        }

        // Show extras modal with proper state
        function showExtrasModal() {
            if (!liveMatch.isMatchActive) return;
            
            // Reset any previous selections
            const modal = document.getElementById('extrasModal');
            const buttons = modal.querySelectorAll('.extra-option');
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            // Show the modal
            modal.style.display = 'flex';
            
            // Update UI based on match state
            updateExtrasModalUI();
        }
        
        // Update extras modal UI based on current match state
        function updateExtrasModalUI() {
            // Update team names and scores in the modal
            const battingTeam = liveMatch.currentInnings.team;
            const bowlingTeam = liveMatch.currentInnings.team === liveMatch.teamA.name ? 
                liveMatch.teamB.name : liveMatch.teamA.name;
                
            document.getElementById('extrasBattingTeam').textContent = battingTeam;
            document.getElementById('extrasBowlingTeam').textContent = bowlingTeam;
            document.getElementById('extrasCurrentScore').textContent = 
                `${liveMatch.currentInnings.score}/${liveMatch.currentInnings.wickets}`;
            document.getElementById('extrasOvers').textContent = 
                formatOvers(liveMatch.currentInnings.balls);
        }

        // Close extras modal
        function closeExtrasModal() {
            document.getElementById('extrasModal').style.display = 'none';
        }

        function addWicket(wicketType, nextBatsman, fielder = '') {
            if (!liveMatch.isMatchActive) return;
            
            storeLastBall();
            
            // Update wickets
            liveMatch.currentInnings.wickets++;
            liveMatch.currentInnings.balls++;
            liveMatch.currentBowler.balls++;
            liveMatch.currentBowler.wickets++;
            liveMatch.partnership.balls++;
            
            // Mark batsman as out
            const outBatsman = liveMatch.currentBatsmen.striker.name;
            liveMatch.playerStats[outBatsman].isOut = true;
            liveMatch.playerStats[outBatsman].howOut = wicketType;
            liveMatch.playerStats[outBatsman].bowlerOut = liveMatch.currentBowler.name;
            liveMatch.playerStats[outBatsman].fielderOut = fielder;
            
            // Record ball
            recordBall('wicket', 0, outBatsman, wicketType);
            
            // Add commentary
            addWicketCommentary(wicketType, outBatsman, fielder);
            
            // Replace striker with next batsman
            liveMatch.currentBatsmen.striker = {
                name: nextBatsman,
                runs: 0, balls: 0, fours: 0, sixes: 0
            };
            
            // Reset partnership
            liveMatch.partnership = { runs: 0, balls: 0 };
            
            // Check for over completion
            if (liveMatch.currentInnings.balls === 6) {
                completeOver();
            } else {
                updateAllDisplays();
            }
            
            // Check for innings completion
            checkInningsCompletion();
            
            document.getElementById('undoBtn').disabled = false;
        }

        function rotateStrike() {
            const temp = liveMatch.currentBatsmen.striker;
            liveMatch.currentBatsmen.striker = liveMatch.currentBatsmen.nonStriker;
            liveMatch.currentBatsmen.nonStriker = temp;
        }

        function completeOver() {
            // AUTHENTIC CRICKET OVER COMPLETION LOGIC:
            // When the count reaches ".6":
            // - The over is considered complete.
            // - Prompt the user to SELECT the next bowler name from the bowling team's player list.
            // - Ensure the same bowler is not selected for consecutive overs.
            // - Increment the over count (e.g., 0.6  1.0).
            // - Reset ball count to 0 and start tracking the next over.
            liveMatch.currentInnings.overs++;  // 01, 12, 23, etc.
            liveMatch.currentInnings.balls = 0; // Reset to start next over at .0
            
            // Check for maiden over
            if (liveMatch.currentBowler.runs === 0) {
                liveMatch.currentBowler.maidens++;
            }
            
            addCommentary(`End of over ${liveMatch.currentInnings.overs}. ${teamData[`team${liveMatch.currentInnings.batting}`].name}: ${liveMatch.currentInnings.score}/${liveMatch.currentInnings.wickets}`);
            
            // END OF OVER STRIKE ROTATION LOGIC - AUTHENTIC CRICKET RULE:
            // If striker scored ODD runs (1, 3, 5) on last ball  Striker will face the next over first ball
            // If striker scored EVEN runs (0, 2, 4, 6) on last ball  Non-striker will face the next over first ball
            if (liveMatch.lastBallRuns !== undefined) {
                if (liveMatch.lastBallRuns % 2 === 0) {
                    // Even runs (0, 2, 4, 6) on last ball  Non-striker faces next over first ball
                    rotateStrike();
                    addCommentary(`Strike rotated: Non-striker will face the first ball of over ${liveMatch.currentInnings.overs}`);
                } else {
                    // Odd runs (1, 3, 5) on last ball  Striker continues to face next over first ball
                    addCommentary(`Strike unchanged: Striker will face the first ball of over ${liveMatch.currentInnings.overs}`);
                }
            } else {
                // Fallback to default behavior if lastBallRuns not set
                rotateStrike();
            }
            
            // Reset last ball runs for next over
            liveMatch.lastBallRuns = undefined;
            
            // Store previous bowler and automatically show bowler change modal
            liveMatch.previousBowler = liveMatch.currentBowler.name;
            
            if (liveMatch.currentInnings.overs < matchConfig.overs) {
                // AUTOMATIC BOWLER CHANGE AFTER EACH OVER - CORRECT FORMAT:
                // Over 0: 0.10.20.30.40.50.6 Complete  "Over 0 completed, select bowler for over 1"
                // Over 1: 1.11.21.31.41.51.6 Complete  "Over 1 completed, select bowler for over 2"  
                // Over 2: 2.12.22.32.42.52.6 Complete  "Over 2 completed, select bowler for over 3"
                // Over 3: 3.13.23.33.43.53.6 Complete  "Over 3 completed, select bowler for over 4"
                // Each over starts at .1 and goes to .6, then next over starts at next number .1
                addCommentary(` Over ${liveMatch.currentInnings.overs - 1} completed, select bowler for over ${liveMatch.currentInnings.overs}`);
                setTimeout(() => {
                    showBowlerChangeModal(); // Automatically shows bowler selection modal
                }, 1000); // 1-second delay for user clarity
            }
            
            updateAllDisplays();
        }

        function checkInningsCompletion() {
            const totalBalls = liveMatch.currentInnings.overs * 6 + liveMatch.currentInnings.balls;
            const maxBalls = matchConfig.overs * 6;
            
            // PROPER CRICKET MATCH END RULES:
            if (liveMatch.innings === 1) {
                // First innings: End when all wickets lost or overs completed
                if (liveMatch.currentInnings.wickets >= 10 || totalBalls >= maxBalls) {
                    endInnings();
                }
            } else {
                // Second innings: Multiple end conditions
                const firstInningsScore = getFirstInningsScore();
                const target = firstInningsScore + 1;
                const currentScore = liveMatch.currentInnings.score;
                
                // Rule 1: If Team B reaches or exceeds target, match ends immediately and Team B wins
                if (currentScore >= target) {
                    endMatch('target_reached');
                    return;
                }
                
                // Rule 2: If Team B loses all 10 wickets before reaching target, Team A wins
                if (liveMatch.currentInnings.wickets >= 10) {
                    endMatch('all_out');
                    return;
                }
                
                // Rule 3: If overs completed and Team B's score < target, Team A wins
                if (totalBalls >= maxBalls) {
                    endMatch('overs_completed');
                    return;
                }
            }
        }

        function endInnings() {
            liveMatch.isMatchActive = false;
            
            if (liveMatch.innings === 1) {
                // Store first innings score for target calculation
                liveMatch.firstInningsScore = liveMatch.currentInnings.score;
                
                addCommentary(`End of first innings. ${teamData[`team${liveMatch.currentInnings.batting}`].name}: ${liveMatch.currentInnings.score}/${liveMatch.currentInnings.wickets}`);
                addCommentary(`Target for ${teamData[`team${liveMatch.currentInnings.bowling}`].name}: ${liveMatch.firstInningsScore + 1} runs`);
                
                // Start second innings
                setTimeout(() => {
                    startSecondInnings();
                }, 2000);
            } else {
                // Match completed normally (shouldn't reach here with new logic)
                endMatch('normal');
            }
        }

        function startSecondInnings() {
            // Check if teamData is properly initialized
            if (!teamData || !teamData.teamA || !teamData.teamB) {
                console.error('teamData is not properly initialized');
                alert('Error: Team data is not available. Please set up teams first.');
                return;
            }
            
            // Check if teams have names and players
            if (!teamData.teamA.name || !teamData.teamB.name || 
                teamData.teamA.players.length === 0 || teamData.teamB.players.length === 0) {
                console.error('Teams are not properly configured');
                alert('Error: Teams must have names and players. Please complete team setup first.');
                return;
            }
            
            // Switch teams
            const newBattingTeam = liveMatch.currentInnings.bowling;
            const newBowlingTeam = liveMatch.currentInnings.batting;
            
            // Ensure scorecards object is initialized
            if (!liveMatch.scorecards) {
                liveMatch.scorecards = {
                    teamA: {
                        firstInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } },
                        secondInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } }
                    },
                    teamB: {
                        firstInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } },
                        secondInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } }
                    }
                };
            }
            
            // Store first innings data in scorecards
            const firstInningsTeam = liveMatch.currentInnings.batting;
            const scorecardKey = `team${firstInningsTeam}`;
            
            if (liveMatch.scorecards[scorecardKey]) {
                liveMatch.scorecards[scorecardKey].firstInnings = {
                    batting: Object.values(liveMatch.playerStats || {}).filter(p => p.team === firstInningsTeam),
                    bowling: Object.values(liveMatch.bowlerStats || {}).filter(b => b.team !== firstInningsTeam),
                    score: liveMatch.currentInnings.score,
                    wickets: liveMatch.currentInnings.wickets,
                    overs: liveMatch.currentInnings.overs + (liveMatch.currentInnings.balls / 6),
                    extras: { ...liveMatch.currentInnings.extras }
                };
            }
            
            liveMatch.innings = 2;
            liveMatch.currentInnings = {
                batting: newBattingTeam,
                bowling: newBowlingTeam,
                score: 0, wickets: 0, overs: 0, balls: 0,
                extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 }
            };
            
            // Initialize second innings player stats
            liveMatch.secondInningsPlayerStats = {};
            liveMatch.secondInningsBowlerStats = {};
            
            addCommentary(` SECOND INNINGS BEGINS!`);
            const battingTeamName = newBattingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name;
            addCommentary(`${battingTeamName} needs ${liveMatch.firstInningsScore + 1} runs to win.`);
            
            // Show comprehensive second innings setup modal
            showSecondInningsSetupModal();
        }

        // Modal functions
        function showWicketModal() {
            if (!liveMatch.isMatchActive) return;
            
            // Populate next batsman dropdown
            const nextBatsmanSelect = document.getElementById('nextBatsman');
            nextBatsmanSelect.innerHTML = '<option value="">Select next batsman</option>';
            
            teamData[`team${liveMatch.currentInnings.batting}`].players.forEach(player => {
                if (!liveMatch.playerStats[player.name].isOut && 
                    player.name !== liveMatch.currentBatsmen.striker.name && 
                    player.name !== liveMatch.currentBatsmen.nonStriker.name) {
                    nextBatsmanSelect.innerHTML += `<option value="${player.name}">${player.name}</option>`;
                }
            });
            
            // Show/hide fielder dropdown based on wicket type
            document.getElementById('wicketType').addEventListener('change', function() {
                const fielderGroup = document.getElementById('fielderGroup');
                const fielderSelect = document.getElementById('fielder');
                
                if (this.value === 'caught' || this.value === 'stumped' || this.value === 'runout') {
                    fielderGroup.style.display = 'block';
                    fielderSelect.innerHTML = '<option value="">Select fielder</option>';
                    teamData[`team${liveMatch.currentInnings.bowling}`].players.forEach(player => {
                        fielderSelect.innerHTML += `<option value="${player.name}">${player.name}</option>`;
                    });
                } else {
                    fielderGroup.style.display = 'none';
                }
            });
            
            document.getElementById('wicketModal').style.display = 'flex';
        }

        function closeWicketModal() {
            document.getElementById('wicketModal').style.display = 'none';
        }

        // Track runs scored before wicket
        let runsBeforeWicket = 0;
        let wicketWithRuns = false;
        
        // Wide Modal Functions
        function showWideModal() {
            // Reset form
            document.getElementById('wideType').value = '';
            
            // Show the modal
            document.getElementById('wideModal').style.display = 'flex';
        }
        
        function closeWideModal() {
            document.getElementById('wideModal').style.display = 'none';
        }
        
        function confirmWide() {
            const wideType = document.getElementById('wideType');
            
            // Validate selection
            if (!wideType.value) {
                alert('Please select a wide type');
                return;
            }
            
            // Get the number of runs (1-5)
            const runs = parseInt(wideType.value);
            
            // Add the wide (1 run for the wide + additional runs)
            addExtra('wide', runs);
            
            // Close the modal
            closeWideModal();
            
            // Update the UI
            updateAllDisplays();
        }
        
        // No Ball Modal Functions
        function showNoBallModal() {
            document.getElementById('noBallRuns').value = '';
            document.getElementById('noBallModal').style.display = 'flex';
        }
        
        function closeNoBallModal() {
            document.getElementById('noBallModal').style.display = 'none';
        }
        
        function confirmNoBall() {
            const noBallRuns = document.getElementById('noBallRuns');
            
            if (!noBallRuns.value) {
                alert('Please select the number of runs');
                return;
            }
            
            const runs = parseInt(noBallRuns.value);
            addExtra('noball', runs);
            closeNoBallModal();
            updateAllDisplays();
        }
        
        // Close modal when clicking outside the content
        window.onclick = function(event) {
            const wideModal = document.getElementById('wideModal');
            const byeModal = document.getElementById('byeModal');
            const legByeModal = document.getElementById('legByeModal');
            const noBallModal = document.getElementById('noBallModal');
            
            if (event.target === wideModal) {
                closeWideModal();
            }
            if (event.target === byeModal) {
                closeByeModal();
            }
            if (event.target === legByeModal) {
                closeLegByeModal();
            }
            if (event.target === noBallModal) {
                closeNoBallModal();
            }
        };
        
        // Bye Modal Functions
        function showByeModal() {
            document.getElementById('byeRuns').value = '';
            document.getElementById('byeModal').style.display = 'flex';
        }
        
        function closeByeModal() {
            document.getElementById('byeModal').style.display = 'none';
        }
        
        function confirmBye() {
            const byeRuns = document.getElementById('byeRuns');
            
            if (!byeRuns.value) {
                alert('Please select the number of runs');
                return;
            }
            
            const runs = parseInt(byeRuns.value);
            addExtra('bye', runs);
            closeByeModal();
            updateAllDisplays();
        }
        
        // Leg Bye Modal Functions
        function showLegByeModal() {
            document.getElementById('legByeRuns').value = '';
            document.getElementById('legByeModal').style.display = 'flex';
        }
        
        function closeLegByeModal() {
            document.getElementById('legByeModal').style.display = 'none';
        }
        
        function confirmLegBye() {
            const legByeRuns = document.getElementById('legByeRuns');
            
            if (!legByeRuns.value) {
                alert('Please select the number of runs');
                return;
            }
            
            const runs = parseInt(legByeRuns.value);
            addExtra('legbye', runs);
            closeLegByeModal();
            updateAllDisplays();
        }

        function addRunsBeforeWicket(runs) {
            runsBeforeWicket = runs;
            wicketWithRuns = true;
            
            // Update the UI to show selected runs
            const runsInfo = document.getElementById('wicketRunsInfo');
            const runsText = document.getElementById('wicketRunsText');
            
            if (runs > 0) {
                runsText.textContent = `Will add ${runs} run${runs > 1 ? 's' : ''} before wicket`;
                runsInfo.style.display = 'block';
            } else {
                runsInfo.style.display = 'none';
            }
        }

        function updateWideMode() {
            const wideMode = document.getElementById('wideMode').value;
            if (wideMode) {
                // Extract the number of runs from the wide mode (e.g., 'wd+2' -> 2)
                const runs = parseInt(wideMode.split('+')[1]) || 0;
                // Update the runs input field with the selected value
                document.getElementById('wicketExtrasRunCount').value = runs;
            }
        }
        
        function updateWicketType() {
            try {
                const wicketTypeElement = document.getElementById('wicketType');
                if (!wicketTypeElement) return;
                
                const wicketType = wicketTypeElement.value;
                const wicketExtrasRuns = document.getElementById('wicketExtrasRuns');
                const fielderGroup = document.getElementById('fielderGroup');
                const wideModeGroup = document.getElementById('wideModeGroup');
                const wideModeElement = document.getElementById('wideMode');
                
                // Safely reset wide mode selection
                if (wideModeElement) {
                    wideModeElement.selectedIndex = 0;
                }
                
                // Show/hide elements based on wicket type
                if (wideModeGroup) {
                    wideModeGroup.style.display = wicketType === 'wide' ? 'block' : 'none';
                }
                
                if (wicketExtrasRuns) {
                    wicketExtrasRuns.style.display = ['noball', 'bye', 'legbye'].includes(wicketType) ? 'block' : 'none';
                }
                
                if (fielderGroup) {
                    fielderGroup.style.display = ['caught', 'stumped', 'runout'].includes(wicketType) ? 'block' : 'none';
                }
            } catch (error) {
                console.error('Error in updateWicketType:', error);
            }
        }

        function confirmWicket() {
            const wicketType = document.getElementById('wicketType').value;
            const nextBatsman = document.getElementById('nextBatsman').value;
            const fielder = document.getElementById('fielder').value;
            const wicketExtrasRunCount = document.getElementById('wicketExtrasRunCount').value || '0';
            
            if (!wicketType) {
                alert('Please select a wicket type');
                return;
            }
            
            if (!nextBatsman) {
                alert('Please select the next batsman');
                return;
            }
            
            if ((wicketType === 'caught' || wicketType === 'stumped' || wicketType === 'runout') && !fielder) {
                alert('Please select the fielder');
                return;
            }
            
            // Handle extras with wicket
            if (['wide', 'noball', 'bye', 'legbye'].includes(wicketType)) {
                const runs = parseInt(wicketExtrasRunCount) || 0;
                
                // Add the extra first
                if (wicketType === 'wide' || wicketType === 'noball') {
                    // For wides and noballs, add 1 to the extra runs
                    addExtra(wicketType, runs);
                } else {
                    // For byes and leg byes, the runs are the actual runs
                    addExtra(wicketType, runs);
                }
                
                // Then add the wicket
                setTimeout(() => {
                    addWicket('bowled', nextBatsman, '');
                    closeWicketModal();
                    
                    // Reset the form
                    document.getElementById('wicketType').selectedIndex = 0;
                    document.getElementById('wicketExtrasRunCount').value = '0';
                    document.getElementById('wicketExtrasRuns').style.display = 'none';
                }, 50);
                
                return;
            }
            
            // Handle standard wickets with potential runs before wicket
            if (wicketWithRuns && runsBeforeWicket > 0) {
                // Add the runs to the batsman's score and team total
                addRuns(runsBeforeWicket);
                // Reset the runs before adding the wicket
                runsBeforeWicket = 0;
                wicketWithRuns = false;
                
                // Small delay to ensure the runs are processed before the wicket
                setTimeout(() => {
                    addWicket(wicketType, nextBatsman, fielder);
                    closeWicketModal();
                }, 50);
            } else {
                // No runs before wicket, proceed normally
                addWicket(wicketType, nextBatsman, fielder);
                closeWicketModal();
            }
        }

        function showExtrasModal() {
            if (!liveMatch.isMatchActive) return;
            document.getElementById('extrasModal').style.display = 'flex';
        }

        function closeExtrasModal() {
            document.getElementById('extrasModal').style.display = 'none';
        }

        function updateExtraOptions() {
            const extraType = document.getElementById('extraType').value;
            const helpText = document.getElementById('extraHelp');
            
            switch(extraType) {
                case 'wide':
                    helpText.textContent = 'Wide ball + any additional runs scored';
                    break;
                case 'noball':
                    helpText.textContent = 'No ball + any additional runs scored';
                    break;
                case 'bye':
                    helpText.textContent = 'Runs scored without bat touching ball';
                    break;
                case 'legbye':
                    helpText.textContent = 'Runs scored off the batsman\'s body';
                    break;
            }
        }

        function confirmExtra() {
            const extraType = document.getElementById('extraType').value;
            const additionalRuns = parseInt(document.getElementById('extraRuns').value) || 0;
            
            addExtra(extraType, additionalRuns);
            closeExtrasModal();
        }

        // COMPREHENSIVE EXTRAS FUNCTION - FIXED
        function addExtraQuick(type, additionalRuns) {
            try {
                console.log(`Adding extra: ${type} + ${additionalRuns} runs`);
                
                if (!liveMatch || !liveMatch.isMatchActive) {
                    alert('Match is not active!');
                    return;
                }
                
                // Close the extras modal immediately
                closeExtrasModal();
                
                // Add the extra with the specified type and additional runs
                addExtra(type, additionalRuns);
                
                console.log('Extra added successfully');
                
            } catch (error) {
                console.error('Error in addExtraQuick:', error);
                alert('Error adding extra: ' + error.message);
            }
        }

        function showBowlerChangeModal() {
            const newBowlerSelect = document.getElementById('newBowler');
            newBowlerSelect.innerHTML = '<option value="">Select new bowler</option>';
            
            // Get bowling team data safely
            const bowlingTeam = liveMatch.currentInnings.bowling;
            const bowlingTeamData = bowlingTeam === 'A' ? teamData.teamA : teamData.teamB;
            const bowlingTeamName = bowlingTeamData.name;
            
            // Get available bowlers based on innings
            let availableBowlers = [];
            
            if (liveMatch.innings === 1) {
                // First innings - use all players from bowling team
                availableBowlers = bowlingTeamData.players;
            } else {
                // Second innings - use available bowlers list set during second innings setup
                if (liveMatch.availableBowlers && liveMatch.availableBowlers.length > 0) {
                    availableBowlers = bowlingTeamData.players.filter(player => 
                        liveMatch.availableBowlers.includes(player.name)
                    );
                } else {
                    // Fallback to all players if availableBowlers not set
                    availableBowlers = bowlingTeamData.players;
                }
            }
            
            // Populate dropdown with available bowlers (excluding previous bowler and checking over limits)
            availableBowlers.forEach(player => {
                const canBowl = player.name !== liveMatch.previousBowler && 
                               (!liveMatch.bowlerOverCounts || 
                                !liveMatch.maxOversPerBowler || 
                                (liveMatch.bowlerOverCounts[player.name] || 0) < liveMatch.maxOversPerBowler);
                
                if (canBowl) {
                    const overCount = liveMatch.bowlerOverCounts ? (liveMatch.bowlerOverCounts[player.name] || 0) : 0;
                    const maxOvers = liveMatch.maxOversPerBowler || 'N/A';
                    newBowlerSelect.innerHTML += `<option value="${player.name}">${player.name} (${overCount}/${maxOvers} overs)</option>`;
                }
            });
            
            // Update modal title to show team name
            const modalTitle = document.querySelector('#bowlerChangeModal h3');
            if (modalTitle) {
                modalTitle.textContent = `Select Next Bowler - ${bowlingTeamName}`;
            }
            
            document.getElementById('bowlerChangeModal').style.display = 'flex';
        }

        function closeBowlerChangeModal() {
            document.getElementById('bowlerChangeModal').style.display = 'none';
        }

        function confirmBowlerChange() {
            const newBowler = document.getElementById('newBowler').value;
            
            if (!newBowler) {
                alert('Please select a new bowler');
                return;
            }
            
            // Update previous bowler's over count
            if (liveMatch.previousBowler && liveMatch.bowlerOverCounts) {
                liveMatch.bowlerOverCounts[liveMatch.previousBowler] = 
                    (liveMatch.bowlerOverCounts[liveMatch.previousBowler] || 0) + 1;
            }
            
            // Initialize new bowler in stats if not exists
            const bowlerStatsKey = liveMatch.innings === 1 ? 'bowlerStats' : 'secondInningsBowlerStats';
            if (!liveMatch[bowlerStatsKey][newBowler]) {
                liveMatch[bowlerStatsKey][newBowler] = {
                    name: newBowler,
                    overs: 0,
                    balls: 0,
                    runs: 0,
                    wickets: 0,
                    maidens: 0,
                    economy: 0,
                    team: liveMatch.currentInnings.bowling
                };
            }
            
            // Update current bowler (reset for new over)
            liveMatch.currentBowler = {
                name: newBowler,
                overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0
            };
            
            // Initialize bowler over count if not exists
            if (liveMatch.bowlerOverCounts && !liveMatch.bowlerOverCounts[newBowler]) {
                liveMatch.bowlerOverCounts[newBowler] = 0;
            }
            
            addCommentary(`${newBowler} comes on to bowl over ${liveMatch.currentInnings.overs + 1}.`);
            
            updateAllDisplays();
            closeBowlerChangeModal();
            
            liveMatch.isMatchActive = true;
        }

        // Utility functions for ball-by-ball scoring
        function storeLastBall() {
            liveMatch.lastBall = {
                innings: JSON.parse(JSON.stringify(liveMatch.currentInnings)),
                batsmen: JSON.parse(JSON.stringify(liveMatch.currentBatsmen)),
                bowler: JSON.parse(JSON.stringify(liveMatch.currentBowler)),
                partnership: JSON.parse(JSON.stringify(liveMatch.partnership)),
                playerStats: JSON.parse(JSON.stringify(liveMatch.playerStats)),
                bowlerStats: JSON.parse(JSON.stringify(liveMatch.bowlerStats))
            };
        }

        function recordBall(type, runs, batsman, extra = '') {
            const ball = {
                over: liveMatch.currentInnings.overs,
                ball: liveMatch.currentInnings.balls,
                type: type,
                runs: runs,
                batsman: batsman,
                bowler: liveMatch.currentBowler.name,
                extra: extra,
                timestamp: new Date().toISOString()
            };
            liveMatch.ballByBall.push(ball);
        }

        function addRunsCommentary(runs) {
            let commentary = '';
            switch(runs) {
                case 0:
                    commentary = `Dot ball. ${liveMatch.currentBatsmen.striker.name} defends.`;
                    break;
                case 1:
                    commentary = `Single taken by ${liveMatch.currentBatsmen.striker.name}.`;
                    break;
                case 2:
                    commentary = `Two runs! Good running between the wickets.`;
                    break;
                case 3:
                    commentary = `Three runs! Excellent running.`;
                    break;
                case 4:
                    commentary = `FOUR! Beautiful shot by ${liveMatch.currentBatsmen.striker.name}.`;
                    break;
                case 6:
                    commentary = `SIX! What a shot by ${liveMatch.currentBatsmen.striker.name}!`;
                    break;
                default:
                    commentary = `${runs} runs scored by ${liveMatch.currentBatsmen.striker.name}.`;
            }
            addCommentary(commentary);
        }

        function addExtraCommentary(type, totalRuns, additionalRuns = 0) {
            let commentary = '';
            switch(type) {
                case 'wide':
                    if (additionalRuns > 0) {
                        commentary = `Wide ball! +1 penalty + ${additionalRuns} runs by running = ${totalRuns} total runs. Not a legal delivery.`;
                    } else {
                        commentary = `Wide ball! +1 penalty run to extras. Not a legal delivery.`;
                    }
                    break;
                case 'noball':
                    if (additionalRuns > 0) {
                        commentary = `No ball! +1 penalty to extras + ${additionalRuns} runs${additionalRuns === 6 ? ' (SIX!)' : ''} by ${liveMatch.currentBatsmen.striker.name} = ${totalRuns} total runs. Not a legal delivery.`;
                    } else {
                        commentary = `No ball! +1 penalty run to extras. Not a legal delivery.`;
                    }
                    break;
                case 'bye':
                    commentary = `Bye! Ball missed by batsman, ${additionalRuns} run${additionalRuns > 1 ? 's' : ''} taken by running. Runs go to extras, not batsman. Legal delivery.`;
                    break;
                case 'legbye':
                    commentary = `Leg bye! Ball hit batsman's body, ${additionalRuns} run${additionalRuns > 1 ? 's' : ''} taken by running. Runs go to extras, not batsman. Legal delivery.`;
                    break;
            }
            
            // Add boundary notification if applicable
            if (type === 'noball' && (additionalRuns === 4 || additionalRuns === 6)) {
                const boundaryType = additionalRuns === 4 ? 'FOUR' : 'SIX';
                showNotification(boundaryType, additionalRuns === 6 ? 'six' : 'four');
            }
            
            addCommentary(commentary);
            
            // Update scorecard highlights
            highlightScorecard('extras');
        }

        function addWicketCommentary(wicketType, batsman, fielder) {
            let commentary = `WICKET! ${batsman} is out `;
            switch(wicketType) {
                case 'bowled':
                    commentary += `bowled by ${liveMatch.currentBowler.name}!`;
                    break;
                case 'caught':
                    commentary += `caught by ${fielder} off ${liveMatch.currentBowler.name}!`;
                    break;
                case 'lbw':
                    commentary += `LBW to ${liveMatch.currentBowler.name}!`;
                    break;
                case 'stumped':
                    commentary += `stumped by ${fielder} off ${liveMatch.currentBowler.name}!`;
                    break;
                case 'runout':
                    commentary += `run out by ${fielder}!`;
                    break;
                case 'hitwicket':
                    commentary += `hit wicket!`;
                    break;
            }
            addCommentary(commentary);
        }

        function addCommentary(text) {
            const commentaryFeed = document.getElementById('commentaryFeed');
            const commentaryItem = document.createElement('div');
            commentaryItem.className = 'commentary-item';
            
            const timestamp = new Date().toLocaleTimeString();
            commentaryItem.innerHTML = `
                <span class="commentary-time">${timestamp}</span>
                <span class="commentary-text">${text}</span>
            `;
            
            commentaryFeed.insertBefore(commentaryItem, commentaryFeed.firstChild);
            
            // Keep only last 50 commentary items
            while (commentaryFeed.children.length > 50) {
                commentaryFeed.removeChild(commentaryFeed.lastChild);
            }
        }

        function updateAllDisplays() {
            updateScoreboard();
            updateBatsmenStats();
            updateBowlerStats();
            updatePartnership();
            updateOverProgress();
            updateExtrasDisplay();
        }

        function updateExtrasDisplay() {
            if (!liveMatch || !liveMatch.currentInnings) return;
            
            const extras = liveMatch.currentInnings.extras;
            
            // Update individual extras runs (actual runs scored from each extra type)
            // Note: We're using the 'wides', 'noballs', 'legbyes', 'byes' properties for the count
            // and 'widesRuns', 'noballsRuns', 'legbyesRuns', 'byesRuns' for the actual runs
            const widesRuns = extras.widesRuns || (extras.wides || 0);
            const noballsRuns = extras.noballsRuns || (extras.noballs || 0);
            const legbyesRuns = extras.legbyesRuns || (extras.legbyes || 0);
            const byesRuns = extras.byesRuns || (extras.byes || 0);
            
            // Update the display with the runs values
            document.getElementById('widesCount').textContent = widesRuns;
            document.getElementById('noballsCount').textContent = noballsRuns;
            document.getElementById('legbyesCount').textContent = legbyesRuns;
            document.getElementById('byesCount').textContent = byesRuns;
            
            // Calculate and update total extras runs
            const totalExtrasRuns = widesRuns + noballsRuns + legbyesRuns + byesRuns;
            document.getElementById('totalExtras').textContent = totalExtrasRuns;
        }

        function updateScoreboard() {
            document.getElementById('currentScore').textContent = `${liveMatch.currentInnings.score}/${liveMatch.currentInnings.wickets}`;
            
            // CRICKET OVER FORMAT DISPLAY - AUTHENTIC CRICKET FORMAT:
            // 1. Track overs in "over.ball" format:
            //    - Start at 0.0 (before first ball is bowled).
            //    - After first legal ball  0.1
            //    - After second legal ball  0.2
            //    - After third legal ball  0.3
            //    - After fourth legal ball  0.4
            //    - After fifth legal ball  0.5
            //    - After sixth legal ball  0.6
            // 2. When the count reaches ".6":
            //    - The over is considered complete.
            //    - Prompt the user to SELECT the next bowler name from the bowling team's player list.
            //    - Ensure the same bowler is not selected for consecutive overs.
            //    - Increment the over count (e.g., 0.6  1.0).
            //    - Reset ball count to 0 and start tracking the next over.
            document.getElementById('currentOvers').textContent = `${liveMatch.currentInnings.overs}.${liveMatch.currentInnings.balls}`;
            
            const totalBalls = liveMatch.currentInnings.overs * 6 + liveMatch.currentInnings.balls;
            const runRate = totalBalls > 0 ? (liveMatch.currentInnings.score / totalBalls * 6).toFixed(2) : '0.00';
            document.getElementById('runRate').textContent = runRate;
            
            document.getElementById('battingTeamName').textContent = teamData[`team${liveMatch.currentInnings.batting}`].name;
            document.getElementById('bowlingTeamName').textContent = teamData[`team${liveMatch.currentInnings.bowling}`].name;

            // Update Target and Required (only for second innings)
            const targetInfoEl = document.getElementById('targetInfo');
            const requiredInfoEl = document.getElementById('requiredInfo');
            if (targetInfoEl && requiredInfoEl) {
                const isSecondInnings = typeof liveMatch.innings !== 'undefined' && liveMatch.innings === 2;
                const firstInningsScore = typeof liveMatch.firstInningsScore === 'number' ? liveMatch.firstInningsScore : null;
                if (isSecondInnings && firstInningsScore !== null) {
                    const target = firstInningsScore + 1;
                    const current = liveMatch.currentInnings.score;
                    const runsNeeded = Math.max(0, target - current);
                    const ballsBowled = (liveMatch.currentInnings.overs * 6) + liveMatch.currentInnings.balls;
                    const totalBalls = (matchConfig.overs || 0) * 6;
                    const ballsLeft = Math.max(0, totalBalls - ballsBowled);
                    const rrr = ballsLeft > 0 ? ((runsNeeded / ballsLeft) * 6).toFixed(2) : '0.00';

                    targetInfoEl.textContent = `Target: ${target}`;
                    requiredInfoEl.textContent = `Required: ${runsNeeded} off ${ballsLeft} balls (RRR ${rrr})`;
                } else {
                    targetInfoEl.textContent = 'Target: -';
                    requiredInfoEl.textContent = 'Required: -';
                }
            }
        }

        function updateBatsmenStats() {
            // Striker stats
            document.getElementById('strikerName').textContent = liveMatch.currentBatsmen.striker.name;
            document.getElementById('strikerRuns').textContent = liveMatch.currentBatsmen.striker.runs;
            document.getElementById('strikerBalls').textContent = liveMatch.currentBatsmen.striker.balls;
            document.getElementById('strikerFours').textContent = liveMatch.currentBatsmen.striker.fours;
            document.getElementById('strikerSixes').textContent = liveMatch.currentBatsmen.striker.sixes;
            const strikerSR = liveMatch.currentBatsmen.striker.balls > 0 ? 
                (liveMatch.currentBatsmen.striker.runs / liveMatch.currentBatsmen.striker.balls * 100).toFixed(1) : '0.0';
            document.getElementById('strikerSR').textContent = strikerSR;
            
            // Non-striker stats
            document.getElementById('nonStrikerName').textContent = liveMatch.currentBatsmen.nonStriker.name;
            document.getElementById('nonStrikerRuns').textContent = liveMatch.currentBatsmen.nonStriker.runs;
            document.getElementById('nonStrikerBalls').textContent = liveMatch.currentBatsmen.nonStriker.balls;
            document.getElementById('nonStrikerFours').textContent = liveMatch.currentBatsmen.nonStriker.fours;
            document.getElementById('nonStrikerSixes').textContent = liveMatch.currentBatsmen.nonStriker.sixes;
            const nonStrikerSR = liveMatch.currentBatsmen.nonStriker.balls > 0 ? 
                (liveMatch.currentBatsmen.nonStriker.runs / liveMatch.currentBatsmen.nonStriker.balls * 100).toFixed(1) : '0.0';
            document.getElementById('nonStrikerSR').textContent = nonStrikerSR;
        }

        function updateBowlerStats() {
            document.getElementById('bowlerName').textContent = liveMatch.currentBowler.name;
            const bowlerOvers = `${Math.floor(liveMatch.currentBowler.balls / 6)}.${liveMatch.currentBowler.balls % 6}`;
            document.getElementById('bowlerOvers').textContent = bowlerOvers;
            document.getElementById('bowlerRuns').textContent = liveMatch.currentBowler.runs;
            document.getElementById('bowlerWickets').textContent = liveMatch.currentBowler.wickets;
            
            const economy = liveMatch.currentBowler.balls > 0 ? 
                (liveMatch.currentBowler.runs / liveMatch.currentBowler.balls * 6).toFixed(2) : '0.00';
            document.getElementById('bowlerEconomy').textContent = economy;
        }

        function updatePartnership() {
            document.getElementById('partnershipRuns').textContent = liveMatch.partnership.runs;
            document.getElementById('partnershipBalls').textContent = liveMatch.partnership.balls;
        }

        function updateOverProgress() {
            const progressBar = document.querySelector('.over-progress-fill');
            const percentage = (liveMatch.currentInnings.balls / 6) * 100;
            progressBar.style.width = `${percentage}%`;
            
            document.getElementById('ballsInOver').textContent = liveMatch.currentInnings.balls;
        }

        function undoLastBall() {
            if (!liveMatch.lastBall) {
                alert('No ball to undo');
                return;
            }
            
            // Restore previous state
            liveMatch.currentInnings = liveMatch.lastBall.innings;
            liveMatch.currentBatsmen = liveMatch.lastBall.batsmen;
            liveMatch.currentBowler = liveMatch.lastBall.bowler;
            liveMatch.partnership = liveMatch.lastBall.partnership;
            liveMatch.playerStats = liveMatch.lastBall.playerStats;
            liveMatch.bowlerStats = liveMatch.lastBall.bowlerStats;
            
            // Remove last ball from record
            liveMatch.ballByBall.pop();
            liveMatch.lastBall = null;
            
            addCommentary('Last ball undone.');
            updateAllDisplays();
            
            document.getElementById('undoBtn').disabled = true;
        }

        function pauseMatch() {
            liveMatch.isMatchActive = false;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('resumeBtn').style.display = 'inline-flex';
            addCommentary('Match paused.');
        }

        function resumeMatch() {
            liveMatch.isMatchActive = true;
            document.getElementById('pauseBtn').style.display = 'inline-flex';
            document.getElementById('resumeBtn').style.display = 'none';
            addCommentary('Match resumed.');
        }

        // ---- Match History Persistence ----
        function loadMatchHistory() {
            try {
                return JSON.parse(localStorage.getItem('cricketMatchHistory') || '[]');
            } catch { return []; }
        }

        function saveMatchHistory(arr) {
            try { localStorage.setItem('cricketMatchHistory', JSON.stringify(arr)); } catch {}
        }

        function getMatchSnapshot() {
            try {
                const now = new Date();
                const id = `${now.getTime()}-${Math.floor(Math.random()*1e6)}`;
                const innings = liveMatch?.innings || 1;
                const currentInnings = liveMatch?.currentInnings || {};
                const teamAName = teamData?.teamA?.name || 'Team A';
                const teamBName = teamData?.teamB?.name || 'Team B';
                const resultText = liveMatch?.matchResult || '';
                const status = liveMatch?.matchStatus || (resultText ? 'completed' : 'in_progress');
                const code = (window.matchCode) || (function(){ try { return localStorage.getItem('cric_match_code_current'); } catch { return null; } })();
                const matchId = (window.matchId) || (function(){ try { return localStorage.getItem('cric_match_id_current'); } catch { return null; } })();

                const firstInnings = liveMatch?.firstInnings || null;
                const secondInnings = liveMatch?.secondInnings || null;

                // Build roles if available
                const rolesA = (teamData?.teamA && teamData.teamA.roles) ? {
                    captain: teamData.teamA.roles.captain || teamData.teamA.roles.c || null,
                    viceCaptain: teamData.teamA.roles.viceCaptain || teamData.teamA.roles.vc || null,
                    wicketKeeper: teamData.teamA.roles.wicketKeeper || teamData.teamA.roles.wk || null,
                } : null;
                const rolesB = (teamData?.teamB && teamData.teamB.roles) ? {
                    captain: teamData.teamB.roles.captain || teamData.teamB.roles.c || null,
                    viceCaptain: teamData.teamB.roles.viceCaptain || teamData.teamB.roles.vc || null,
                    wicketKeeper: teamData.teamB.roles.wicketKeeper || teamData.teamB.roles.wk || null,
                } : null;

                // Helper to coerce playerStats structures to arrays
                function statsToBatArray(src){
                    if (!src) return [];
                    const arr = Array.isArray(src) ? src : Object.entries(src).map(([name,v])=>({ name, ...(v||{}) }));
                    return arr.map(p=>({
                        name: p.name || '-',
                        runs: p.runs||0,
                        balls: p.balls||0,
                        fours: p.fours||0,
                        sixes: p.sixes||0,
                        sr: p.sr || (p.balls ? ((p.runs||0)/p.balls*100).toFixed(1) : '0.0')
                    }));
                }
                function statsToBowlArray(src){
                    if (!src) return [];
                    const arr = Array.isArray(src) ? src : Object.entries(src).map(([name,v])=>({ name, ...(v||{}) }));
                    return arr.map(b=>({
                        name: b.name || '-',
                        overs: (b.overs!==undefined)? b.overs : (b.ballsBowled!==undefined? `${Math.floor((b.ballsBowled||0)/6)}.${(b.ballsBowled||0)%6}` : undefined),
                        balls: b.ballsBowled,
                        maidens: b.maidens||0,
                        runsConceded: b.runsConceded||b.runsGiven||b.runs||0,
                        wickets: b.wickets||0,
                        econ: (b.ballsBowled && b.ballsBowled>0)? (((b.runsConceded||b.runsGiven||b.runs||0)/b.ballsBowled)*6).toFixed(2) : (b.econ||undefined)
                    }));
                }

                // Pull team-wise stats if available
                const psA = liveMatch?.playerStats?.teamA || liveMatch?.playerStats?.A || liveMatch?.playerStats?.team1 || null;
                const psB = liveMatch?.playerStats?.teamB || liveMatch?.playerStats?.B || liveMatch?.playerStats?.team2 || null;
                const bowlA = liveMatch?.bowlerStats?.teamA || liveMatch?.bowlerStats?.A || liveMatch?.bowlerStats?.team1 || null;
                const bowlB = liveMatch?.bowlerStats?.teamB || liveMatch?.bowlerStats?.B || liveMatch?.bowlerStats?.team2 || null;

                // Prefer innings-specific lists if present; otherwise fallback to aggregate from stats
                const scTeamA = {
                    name: teamAName,
                    firstInnings: {
                        batting: (firstInnings?.batting && Array.isArray(firstInnings.batting)) ? firstInnings.batting : statsToBatArray(psA),
                        bowling: (firstInnings?.bowling && Array.isArray(firstInnings.bowling)) ? firstInnings.bowling : statsToBowlArray(bowlA),
                        extras: firstInnings?.extras || null
                    },
                    secondInnings: {
                        batting: (secondInnings?.batting && Array.isArray(secondInnings.batting)) ? secondInnings.batting : [],
                        bowling: (secondInnings?.bowling && Array.isArray(secondInnings.bowling)) ? secondInnings.bowling : [],
                        extras: secondInnings?.extras || null
                    },
                    roles: rolesA || undefined
                };
                const scTeamB = {
                    name: teamBName,
                    firstInnings: {
                        batting: (firstInnings?.oppositionBatting && Array.isArray(firstInnings.oppositionBatting)) ? firstInnings.oppositionBatting : statsToBatArray(psB),
                        bowling: (firstInnings?.oppositionBowling && Array.isArray(firstInnings.oppositionBowling)) ? firstInnings.oppositionBowling : statsToBowlArray(bowlB),
                        extras: null
                    },
                    secondInnings: {
                        batting: (secondInnings?.oppositionBatting && Array.isArray(secondInnings.oppositionBatting)) ? secondInnings.oppositionBatting : [],
                        bowling: (secondInnings?.oppositionBowling && Array.isArray(secondInnings.oppositionBowling)) ? secondInnings.oppositionBowling : [],
                        extras: null
                    },
                    roles: rolesB || undefined
                };

                const fullScorecard = { teamA: scTeamA, teamB: scTeamB };

                const toss = matchConfig?.toss || null;
                const venue = matchConfig?.venue || '';

                return {
                    id,
                    savedAt: now.toISOString(),
                    config: { overs: matchConfig?.overs || 0, venue: matchConfig?.venue || '', toss: matchConfig?.toss || '' },
                    teams: { A: { name: teamAName }, B: { name: teamBName } },
                    matchCode: code || null,
                    matchId: matchId || null,
                    inningsNumber: innings,
                    firstInnings,
                    secondInnings,
                    current: {
                        score: currentInnings.score || 0,
                        wickets: currentInnings.wickets || 0,
                        overs: currentInnings.overs || 0,
                        balls: currentInnings.balls || 0,
                        batting: currentInnings.batting || 'A',
                        bowling: currentInnings.bowling || 'B'
                    },
                    playerStats: liveMatch?.playerStats || {},
                    bowlerStats: liveMatch?.bowlerStats || {},
                    commentary: liveMatch?.ballByBall || [],
                    result: {
                        result: resultText,
                        status: status,
                        toss: toss,
                        venue: venue,
                        fullScorecard: fullScorecard
                    },
                    status
                };
            } catch (e) {
                console.warn('getMatchSnapshot failed:', e);
                return null;
            }
        }

        function saveMatchToHistory() {
            const snap = getMatchSnapshot();
            if (!snap) { alert('Unable to save match.'); return; }
            // Ensure we have a stable matchId
            if (!snap.matchId) snap.matchId = snap.matchCode || `M-${Date.now()}`;
            const doc = buildDbMatchFromSnapshot(snap);
            // Persist to backend (MongoDB) only
            try {
                console.log('Saving match data:', JSON.stringify(doc, null, 2));
                fetch('http://localhost:5502/api/matches', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(doc)
                })
                .then(async (res) => {
                    const responseText = await res.text();
                    let responseData;
                    try {
                        responseData = responseText ? JSON.parse(responseText) : {};
                    } catch (e) {
                        responseData = { rawResponse: responseText };
                    }
                    
                    if (!res.ok) {
                        console.error('Server response error:', {
                            status: res.status,
                            statusText: res.statusText,
                            headers: Object.fromEntries(res.headers.entries()),
                            body: responseData
                        });
                        throw new Error(`POST /api/matches failed with status ${res.status}: ${JSON.stringify(responseData)}`);
                    }
                    
                    try { addCommentary('Match saved to database.'); } catch {}
                    try { showMessage && showMessage('Match saved to database', 'success'); } catch {}
                    console.log('Match saved successfully:', responseData);
                })
                .catch((e) => {
                    console.error('Save to DB failed:', e);
                    try { 
                        showMessage && showMessage('Failed to save match to database: ' + e.message, 'error'); 
                    } catch {}
                });
            } catch {}
        }

        // --- Post-match save UX and DB display ---
        function showSaveBanner() {
            try {
                const existing = document.getElementById('saveMatchBanner');
                if (existing) existing.remove();
                const banner = document.createElement('div');
                banner.id = 'saveMatchBanner';
                banner.style.cssText = 'position:fixed;left:50%;top:20px;transform:translateX(-50%);background:#0ea5e9;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.15);z-index:9999;display:flex;gap:10px;align-items:center;';
                banner.innerHTML = '<strong>Match completed.</strong><button id="btnSaveFinal" style="background:#fff;color:#0ea5e9;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:600;">Save Match</button><button id="btnDismissFinal" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.6);border-radius:8px;padding:6px 10px;cursor:pointer;">Dismiss</button>';
                document.body.appendChild(banner);
                document.getElementById('btnDismissFinal').onclick = ()=> banner.remove();
                document.getElementById('btnSaveFinal').onclick = async ()=>{
                    banner.innerHTML = 'Saving';
                    await saveFinalMatchAndShow();
                    banner.remove();
                };
            } catch {}
        }

        async function saveFinalMatchAndShow() {
            try {
                // Save locally and to DB, then fetch from DB and render a summary box
                const snap = getMatchSnapshot();
                if (!snap) { 
                    alert('Unable to save match: No match data available'); 
                    return; 
                }
                
                // Ensure status is completed
                if (snap.result && typeof snap.result === 'object') snap.result.status = 'completed';
                if (!snap.matchId) snap.matchId = snap.matchCode || `M-${Date.now()}`;
                const mid = snap.matchId;
                const doc = buildDbMatchFromSnapshot(snap);
                
                // Debug: Log the request payload
                console.log(' Sending match data to server:', {
                    url: 'http://localhost:5502/api/matches',
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: doc
                });
                
                // Save to database
                const res = await fetch('http://localhost:5502/api/matches', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(doc) 
                });
                
                // Read the response once and store it
                const responseText = await res.text();
                
                // Log the response for debugging
                console.log(' Server response:', {
                    status: res.status,
                    statusText: res.statusText,
                    headers: Object.fromEntries(res.headers.entries()),
                    body: responseText
                });
                
                // Parse the response as JSON if possible
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    responseData = responseText;
                }
                
                if (!res.ok) {
                    const errorDetails = typeof responseData === 'object' ? responseData : responseText;
                    throw new Error(`POST failed ${res.status}: ${JSON.stringify(errorDetails)}`);
                }
                
                // If we have a successful response with data, use it
                if (responseData && responseData.data) {
                    renderSavedDetails(responseData.data);
                    return responseData.data;
                }
                
                // If no data in response but we have a match ID, try to fetch it
                if (mid) {
                    try {
                        const res = await fetch(`http://localhost:5502/api/matches/${encodeURIComponent(mid)}`);
                        const json = await res.json();
                        if (json && json.data) {
                            renderSavedDetails(json.data);
                            return json.data;
                        }
                    } catch (fetchError) {
                        console.error('Error fetching saved match:', fetchError);
                    }
                }
                
                // Fallback to using the local snapshot if all else fails
                renderSavedDetails(snap);
                return snap;
                
            } catch (e) {
                console.error(' Error saving match:', e);
                // Log the exact error details
                if (e.response) {
                    console.error('Error response data:', e.response.data);
                    console.error('Error response status:', e.response.status);
                    console.error('Error response headers:', e.response.headers);
                } else if (e.request) {
                    console.error('No response received:', e.request);
                } else {
                    console.error('Error setting up request:', e.message);
                }
                
                // Try to render with whatever data we have
                const snap = getMatchSnapshot();
                if (snap) {
                    renderSavedDetails(snap);
                    return snap;
                }
                
                alert('Failed to save match. Please check console for details.');
                throw e; // Re-throw to be handled by the caller
            }
        }

        function buildDbMatchFromSnapshot(snap) {
            const nz = (n, d=0) => {
                const v = Number(n);
                return Number.isFinite(v) ? v : d;
            };
            const cleanExtras = (ex) => {
                const e = ex || {};
                return {
                    wides: nz(e.wides || e.w || e.wd),
                    noBalls: nz(e.noBalls || e.nb),
                    byes: nz(e.byes || e.b),
                    legByes: nz(e.legByes || e.lb),
                    total: nz(e.total)
                };
            };
            const cleanInnings = (inn) => {
                if (!inn) return undefined;
                return {
                    score: nz(inn.score),
                    wickets: nz(inn.wickets),
                    overs: nz(inn.overs),
                    balls: nz(inn.balls),
                    extras: cleanExtras(inn.extras)
                };
            };
            const teamAName = (snap.teams && (snap.teams.A?.name || snap.teams.teamA?.name || snap.teams.teamA)) || 'Team A';
            const teamBName = (snap.teams && (snap.teams.B?.name || snap.teams.teamB?.name || snap.teams.teamB)) || 'Team B';
            const doc = {
                matchId: snap.matchId,
                matchCode: snap.matchCode || undefined,
                savedAt: new Date().toISOString(),
                teams: {
                    A: { name: teamAName },
                    B: { name: teamBName }
                },
                matchConfig: snap.config || snap.matchConfig || undefined,
                firstInnings: cleanInnings(snap.firstInnings),
                secondInnings: cleanInnings(snap.secondInnings),
                current: (function(){
                    const c = snap.current || {};
                    return { score: nz(c.score), wickets: nz(c.wickets), overs: nz(c.overs), balls: nz(c.balls), extras: cleanExtras(c.extras) };
                })(),
                playerStats: snap.playerStats || undefined,
                result: (function(){
                    const r = snap.result || {};
                    const mom = r.manOfTheMatch || undefined;
                    const toss = r.toss || undefined;
                    return {
                        result: r.result || r.status || undefined,
                        status: r.status || undefined,
                        winner: r.winner || undefined,
                        margin: r.margin || undefined,
                        manOfTheMatch: mom ? { name: mom.name, team: mom.team, reason: mom.reason || mom.performance } : undefined,
                        toss: toss ? { winner: toss.winner, decision: toss.decision } : undefined,
                        venue: r.venue || snap.config?.venue || snap.matchConfig?.venue || undefined,
                        fullScorecard: (r.fullScorecard || snap.result?.fullScorecard || snap.fullScorecard || undefined)
                    };
                })()
            };
            return doc;
        }

        function renderSavedDetails(data){
            try {
                const existing = document.getElementById('savedDetailsBox');
                if (existing) existing.remove();
                const box = document.createElement('div');
                box.id = 'savedDetailsBox';
                box.style.cssText = 'position:fixed;right:20px;bottom:20px;max-width:480px;width:90vw;background:#ffffff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 15px 35px rgba(2,6,23,.15);padding:14px;z-index:9998;';
                const teamA = data?.teams?.A?.name || data?.teams?.teamA?.name || 'Team A';
                const teamB = data?.teams?.B?.name || data?.teams?.teamB?.name || 'Team B';
                const resultText = (typeof data?.result==='string')? data.result : (data?.result?.result || '');
                const status = (typeof data?.result==='object')? (data.result.status||'') : (data.status||'');
                const fc = (typeof data?.result==='object')? data.result.fullScorecard : undefined;
                const savedAt = data?.savedAt ? new Date(data.savedAt).toLocaleString() : '';
                let inner = ''+
                `<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;">`+
                `<div style="font-weight:800;color:#0f172a;">Saved Match Details</div>`+
                `<button id="closeSavedDetails" style="background:transparent;border:none;font-size:18px;cursor:pointer;color:#64748b;"></button>`+
                `</div>`+
                `<div style="color:#0f172a;font-weight:700;margin-bottom:4px;">${teamA} vs ${teamB}</div>`+
                (data.matchId? `<div style="font-size:12px;color:#334155;margin-bottom:6px;">Match ID: ${data.matchId}</div>`:'')+
                (savedAt? `<div style="font-size:12px;color:#64748b;margin-bottom:8px;">Saved: ${savedAt}</div>`:'')+
                (resultText? `<div style="margin-bottom:8px;"><span style="background:#22c55e1a;color:#16a34a;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:600;">${status||'completed'}</span> <span style="color:#0f172a;margin-left:6px;">${resultText}</span></div>`:'');

                function renderTable(rows, headers) {
                    if (!rows || !rows.length) return '<div style="padding:8px;color:#64748b;font-size:12px;text-align:center;">No data available</div>';
                    
                    const thead = `<thead><tr>${
                        headers.map(h => 
                            `<th style="text-align:left;padding:8px 10px;background:#f1f5f9;font-size:11px;font-weight:600;color:#475569;text-transform:uppercase;border-bottom:1px solid #e2e8f0;">
                                ${h}
                            </th>`
                        ).join('')
                    }</tr></thead>`;
                    
                    const body = `<tbody>${
                        rows.map((r, i) => {
                            // Highlight the batsman who is currently on strike or the bowler who is currently bowling
                            const isActivePlayer = r.isOnStrike || r.isBowling;
                            return `<tr style="${isActivePlayer ? 'background-color:#f0fdf4;' : ''}">${
                                headers.map(h => {
                                    const value = r[h.toLowerCase()] ?? r[h] ?? '';
                                    // Style runs, wickets, and economy rate differently
                                    const isNumeric = !isNaN(parseFloat(value)) && isFinite(value);
                                    const isBold = h === 'Runs' || h === 'Wickets' || h === 'Batsman' || h === 'Bowler';
                                    return `
                                        <td style="
                                            padding: 8px 10px;
                                            font-size: 12px;
                                            color: ${isNumeric ? (h === 'Runs' ? '#10b981' : h === 'Wickets' ? '#ef4444' : '#334155') : '#334155'};
                                            font-weight: ${isBold ? '600' : '400'};
                                            border-bottom: 1px solid #f1f5f9;
                                        ">
                                            ${value}
                                        </td>`;
                                }).join('')
                            }</tr>`;
                        }).join('')
                    }</tbody>`;
                    
                    return `
                        <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
                            <table style="
                                width: 100%;
                                border-collapse: separate;
                                border-spacing: 0;
                                background: white;
                                border-radius: 4px;
                                overflow: hidden;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                            ">
                                ${thead}
                                ${body}
                            </table>
                        </div>`;
                }

                const batHeaders = ['Batsman','Runs','Balls','4s','6s','SR'];
                const bowlHeaders = ['Bowler','O','M','R','W','Econ'];
                
                // Enhanced batting stats normalization with fallbacks
                const normBat = (arr) => (arr || []).map(p => ({
                    'Batsman': p.name || p.batsman || 'Player',
                    'Runs': p.runs || p.runsScored || 0,
                    'Balls': p.balls || p.ballsFaced || 0,
                    '4s': p.fours || 0,
                    '6s': p.sixes || 0,
                    'SR': p.sr || (p.balls ? ((p.runs || 0) / p.balls * 100).toFixed(2) : '0.00')
                }));
                
                // Enhanced bowling stats normalization with fallbacks
                const normBowl = (arr) => (arr || []).map(b => ({
                    'Bowler': b.name || b.bowler || 'Bowler',
                    'O': b.overs || '0.0',
                    'M': b.maidens || 0,
                    'R': b.runsConceded || b.runs || 0,
                    'W': b.wickets || 0,
                    'Econ': b.econ || (b.overs ? ((b.runsConceded || 0) / parseFloat(b.overs)).toFixed(2) : '0.00')
                }));

                // Data sources with fallback to aggregated playerStats
                const psA = data?.playerStats?.teamA || data?.playerStats?.A || data?.playerStats?.team1 || [];
                const psB = data?.playerStats?.teamB || data?.playerStats?.B || data?.playerStats?.team2 || [];
                const bsA = data?.bowlerStats?.teamA || data?.bowlerStats?.A || data?.bowlerStats?.team1 || [];
                const bsB = data?.bowlerStats?.teamB || data?.bowlerStats?.B || data?.bowlerStats?.team2 || [];

                const fiBatA = fc?.teamA?.firstInnings?.batting ?? psA;
                const fiBowlB = fc?.teamB?.firstInnings?.bowling ?? bsB;
                const siBatB = fc?.teamB?.secondInnings?.batting ?? psB;
                const siBowlA = fc?.teamA?.secondInnings?.bowling ?? bsA;

                // Extras and totals (if provided in fullScorecard or snapshots)
                const fiExtrasA = fc?.teamA?.firstInnings?.extras || data?.firstInnings?.extras || null;
                const siExtrasB = fc?.teamB?.secondInnings?.extras || data?.secondInnings?.extras || null;
                const fiTotalA = data?.firstInnings?.score || data?.firstInnings?.total || data?.current?.score || '';
                const siTotalB = data?.secondInnings?.score || data?.secondInnings?.total || '';

                inner += `<div style=\"margin-top:6px;font-weight:800;color:#0f172a;\">Innings 1</div>`;
                // Innings 1 - Team A Batting
                inner += `<div style="margin-top:12px;padding:8px;background:#f8fafc;border-radius:6px;border-left:3px solid #3b82f6;">`;
                inner += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">`;
                inner += `<div style="font-weight:700;color:#0f172a;">${teamA} Innings</div>`;
                if (fiTotalA) inner += `<div style="font-weight:700;color:#0f172a;">${fiTotalA}</div>`;
                inner += `</div>`;
                
                // Batting card for Team A
                if (fiBatA && fiBatA.length > 0) {
                    inner += `<div style="margin-top:8px;font-size:13px;font-weight:600;color:#475569;">Batting</div>`;
                    inner += renderTable(normBat(fiBatA), batHeaders);
                }
                
                // Bowling card for Team B
                if (fiBowlB && fiBowlB.length > 0) {
                    inner += `<div style="margin-top:12px;font-size:13px;font-weight:600;color:#475569;">Bowling</div>`;
                    inner += renderTable(normBowl(fiBowlB), bowlHeaders);
                }
                
                // Extras and fallback
                if (fiExtrasA) {
                    const extras = typeof fiExtrasA === 'object' ? 
                        Object.entries(fiExtrasA).map(([k,v]) => `${k}: ${v}`).join(', ') : 
                        fiExtrasA;
                    inner += `<div style="margin-top:8px;font-size:12px;color:#475569;"><strong>Extras:</strong> ${extras}</div>`;
                }
                inner += `</div>`; // Close innings 1 container

                // Innings 2 - Team B Batting
                if (siBatB && siBatB.length > 0) {
                    inner += `<div style="margin-top:16px;padding:8px;background:#f8fafc;border-radius:6px;border-left:3px solid #10b981;">`;
                    inner += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">`;
                    inner += `<div style="font-weight:700;color:#0f172a;">${teamB} Innings</div>`;
                    if (siTotalB) inner += `<div style="font-weight:700;color:#0f172a;">${siTotalB}</div>`;
                    inner += `</div>`;
                    
                    // Batting card for Team B
                    inner += `<div style="margin-top:8px;font-size:13px;font-weight:600;color:#475569;">Batting</div>`;
                    inner += renderTable(normBat(siBatB), batHeaders);
                    
                    // Bowling card for Team A
                    if (siBowlA && siBowlA.length > 0) {
                        inner += `<div style="margin-top:12px;font-size:13px;font-weight:600;color:#475569;">Bowling</div>`;
                        inner += renderTable(normBowl(siBowlA), bowlHeaders);
                    }
                    
                    // Extras and fallback
                    if (siExtrasB) {
                        const extras = typeof siExtrasB === 'object' ? 
                            Object.entries(siExtrasB).map(([k,v]) => `${k}: ${v}`).join(', ') : 
                            siExtrasB;
                        inner += `<div style="margin-top:8px;font-size:12px;color:#475569;"><strong>Extras:</strong> ${extras}</div>`;
                    }
                    inner += `</div>`; // Close innings 2 container
                }

                box.innerHTML = inner + `<div style=\"margin-top:10px;text-align:right;\"><a href=\"cric-history.html\" style=\"font-size:12px;color:#2563eb;font-weight:600;\">Open full history </a></div>`;
                document.body.appendChild(box);
                document.getElementById('closeSavedDetails').onclick = ()=> box.remove();
            } catch {}
        }

        // Optional: auto-save snapshot on page exit (DB only, fire-and-forget)
        window.addEventListener('beforeunload', () => {
            try {
                if (!liveMatch) return;
                const snap = getMatchSnapshot();
                if (!snap) return;
                try {
                    navigator.sendBeacon && navigator.sendBeacon('http://localhost:5502/api/matches', new Blob([JSON.stringify(snap)], { type: 'application/json' }));
                } catch {}
            } catch {}
        });

        function endMatch(endReason = 'normal') {
            liveMatch.isMatchActive = false;
            
            // Calculate match result based on proper cricket rules
            const firstInningsScore = getFirstInningsScore();
            const secondInningsScore = liveMatch.currentInnings.score;
            const target = firstInningsScore + 1;
            
            let result = '';
            let matchStatus = '';
            
            if (liveMatch.innings === 1) {
                // First innings completed normally
                result = `First innings completed. ${teamData[`team${liveMatch.currentInnings.batting}`].name}: ${firstInningsScore}`;
                matchStatus = 'first_innings_complete';
            } else {
                // Second innings - apply proper cricket match end rules
                const battingTeamName = teamData[`team${liveMatch.currentInnings.batting}`].name;
                const bowlingTeamName = teamData[`team${liveMatch.currentInnings.bowling}`].name;
                const wicketsRemaining = 10 - liveMatch.currentInnings.wickets;
                const runsShort = target - secondInningsScore;
                
                switch(endReason) {
                    case 'target_reached':
                        // Rule 1: Team B reached/exceeded target
                        result = `${battingTeamName} wins by ${wicketsRemaining} wickets!`;
                        matchStatus = 'won_by_wickets';
                        addCommentary(` TARGET REACHED! ${battingTeamName} wins with ${wicketsRemaining} wickets remaining!`);
                        break;
                        
                    case 'all_out':
                        // Rule 2: Team B all out before reaching target
                        if (secondInningsScore === firstInningsScore) {
                            result = 'Match Tied!';
                            matchStatus = 'tie';
                            addCommentary(` MATCH TIED! Both teams scored ${firstInningsScore} runs!`);
                        } else {
                            result = `${bowlingTeamName} wins by ${runsShort} runs!`;
                            matchStatus = 'won_by_runs';
                            addCommentary(` ${bowlingTeamName} wins! ${battingTeamName} fell short by ${runsShort} runs!`);
                        }
                        break;
                        
                    case 'overs_completed':
                        // Rule 3: Overs completed, Team B's score < target
                        if (secondInningsScore === firstInningsScore) {
                            result = 'Match Tied!';
                            matchStatus = 'tie';
                            addCommentary(` MATCH TIED! Both teams scored ${firstInningsScore} runs!`);
                        } else {
                            result = `${bowlingTeamName} wins by ${runsShort} runs!`;
                            matchStatus = 'won_by_runs';
                            addCommentary(` ${bowlingTeamName} wins! ${battingTeamName} fell short by ${runsShort} runs!`);
                        }
                        break;
                        
                    case 'interrupted':
                        // Rule 5: Match interrupted (rain, etc.)
                        result = 'No Result - Match Interrupted';
                        matchStatus = 'no_result';
                        addCommentary(` MATCH INTERRUPTED! No result declared due to external factors.`);
                        break;
                        
                    default:
                        // Fallback
                        result = 'Match Completed';
                        matchStatus = 'completed';
                }
            }
            
            addCommentary(` MATCH COMPLETED! ${result}`);
            
            // Show match summary with detailed statistics
            showMatchSummary(result, matchStatus, {
                firstInnings: firstInningsScore,
                secondInnings: secondInningsScore,
                target: target,
                endReason: endReason
            });
        }

        function showMatchSummary(result, status, matchData) {
            // Enhanced match summary with comprehensive cricket statistics
            const summary = {
                result: result,
                status: status,
                firstInnings: matchData.firstInnings,
                secondInnings: matchData.secondInnings,
                target: matchData.target,
                endReason: matchData.endReason,
                totalOvers: matchConfig.overs,
                matchDate: new Date().toLocaleDateString(),
                matchTime: new Date().toLocaleTimeString(),
                fullScorecard: (function(){ try { return generateFullScorecard(); } catch(e) { console.warn('generateFullScorecard failed:', e); return null; } })()
            };

            // Compute Man of the Match (if not already set elsewhere)
            try { summary.manOfTheMatch = computeManOfTheMatch(summary.fullScorecard || null); } catch {}

            // Store match result and persist to history
            liveMatch.matchResult = summary;
            try { saveMatchToHistory(); } catch (e) { console.warn('saveMatchToHistory failed:', e); }
            try { displayManOfTheMatch(summary.manOfTheMatch); } catch {}
            
            // Display comprehensive match summary with full scorecards
            setTimeout(() => {
                showDetailedMatchSummaryModal(summary);
            }, 2000);

            // Prompt user to save the final match snapshot to MongoDB
            try { showSaveBanner(); } catch {}
        }
        
        function generateFullScorecard() {
            // Generate comprehensive scorecard for both teams and both innings (safe defaults)
            const aName = (teamData && teamData.teamA && teamData.teamA.name) ? teamData.teamA.name : 'Team A';
            const bName = (teamData && teamData.teamB && teamData.teamB.name) ? teamData.teamB.name : 'Team B';
            const sc = (liveMatch && liveMatch.scorecards) ? liveMatch.scorecards : {};
            const scorecard = {
                teamA: {
                    name: aName,
                    firstInnings: (sc.teamA && sc.teamA.firstInnings) ? sc.teamA.firstInnings : { batting: [], bowling: [], extras: { wides:0, noBalls:0, byes:0, legByes:0, total:0 } },
                    secondInnings: (sc.teamA && sc.teamA.secondInnings) ? sc.teamA.secondInnings : { batting: [], bowling: [], extras: { wides:0, noBalls:0, byes:0, legByes:0, total:0 } }
                },
                teamB: {
                    name: bName,
                    firstInnings: (sc.teamB && sc.teamB.firstInnings) ? sc.teamB.firstInnings : { batting: [], bowling: [], extras: { wides:0, noBalls:0, byes:0, legByes:0, total:0 } },
                    secondInnings: (sc.teamB && sc.teamB.secondInnings) ? sc.teamB.secondInnings : { batting: [], bowling: [], extras: { wides:0, noBalls:0, byes:0, legByes:0, total:0 } }
                }
            };
            return scorecard;
        }

        // Render a simple HTML view for the fullScorecard structure
        function generateScorecardHTML(fullScorecard) {
            const safe = (v, d='') => (v===0 || v) ? v : d;
            if (!fullScorecard || (!fullScorecard.teamA && !fullScorecard.teamB)) {
                return '<div style="padding:10px;color:#64748b;">No scorecard data available.</div>';
            }
            const renderInnings = (title, inn) => {
                if (!inn) return '';
                const bats = Array.isArray(inn.batting) ? inn.batting : [];
                const bowls = Array.isArray(inn.bowling) ? inn.bowling : [];
                const ex = inn.extras || { wides:0,noBalls:0,byes:0,legByes:0,total:0 };
                const batRows = bats.map(p=>
                    `<tr><td>${safe(p.name||p.player,'-')}</td><td>${safe(p.runs,0)}</td><td>${safe(p.balls,0)}</td><td>${safe(p.fours,0)}</td><td>${safe(p.sixes,0)}</td><td>${safe(p.strikeRate||p.sr,'')}</td></tr>`
                ).join('');
                const bowlRows = bowls.map(b=>
                    `<tr><td>${safe(b.name||b.bowler,'-')}</td><td>${safe(b.overs, safe(b.ballsBowled!==undefined? (Math.floor((b.ballsBowled||0)/6)+'.'+((b.ballsBowled||0)%6)) : ''))}</td><td>${safe(b.maidens,0)}</td><td>${safe(b.runsConceded??b.runs,0)}</td><td>${safe(b.wickets,0)}</td><td>${safe(b.economy||b.econ,'')}</td></tr>`
                ).join('');
                return `
                    <div style="border:1px solid #e2e8f0;border-radius:8px;margin:10px 0;">
                      <div style="background:#f8fafc;padding:8px 12px;font-weight:600;">${title}</div>
                      <div style="padding:10px;">
                        <div style="font-weight:600;margin:6px 0;">Batting</div>
                        <table style="width:100%;border-collapse:collapse;">
                          <thead><tr><th style="text-align:left">Batter</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
                          <tbody>${batRows || '<tr><td colspan="6" style="color:#64748b;">No batting data</td></tr>'}</tbody>
                        </table>
                        <div style="margin:8px 0;color:#334155;">Extras: ${safe(ex.total,0)} (w ${safe(ex.wides,0)}, nb ${safe(ex.noBalls,0)}, b ${safe(ex.byes,0)}, lb ${safe(ex.legByes,0)})</div>
                        <div style="font-weight:600;margin:10px 0 6px;">Bowling</div>
                        <table style="width:100%;border-collapse:collapse;">
                          <thead><tr><th style="text-align:left">Bowler</th><th>O</th><th>M</th><th>R</th><th>W</th><th>Econ</th></tr></thead>
                          <tbody>${bowlRows || '<tr><td colspan="6" style="color:#64748b;">No bowling data</td></tr>'}</tbody>
                        </table>
                      </div>
                    </div>`;
            };
            const A = fullScorecard.teamA || { name:'Team A' };
            const B = fullScorecard.teamB || { name:'Team B' };
            return `
              <div>
                <h4 style="margin:10px 0 4px;">${safe(A.name,'Team A')}</h4>
                ${renderInnings('First Innings', A.firstInnings)}
                ${renderInnings('Second Innings', A.secondInnings)}
                <h4 style="margin:14px 0 4px;">${safe(B.name,'Team B')}</h4>
                ${renderInnings('First Innings', B.firstInnings)}
                ${renderInnings('Second Innings', B.secondInnings)}
              </div>`;
        }

        // Compute Man of the Match based on weighted batting, bowling and all-round impact
        function computeManOfTheMatch(fullScorecard) {
            if (!fullScorecard) return null;
            const num = (v) => { const n = Number(v); return isFinite(n) ? n : 0; };
            const pick = (obj, keys, def=0) => {
                if (!obj) return def; for (const k of keys) { if (obj[k] !== undefined && obj[k] !== null) return num(obj[k]); } return def;
            };
            const oversFrom = (p) => {
                if (p && p.overs !== undefined) return num(p.overs);
                if (p && p.ballsBowled !== undefined) return Math.floor(num(p.ballsBowled)/6) + (num(p.ballsBowled)%6)/10; // approx
                return 0;
            };
            // Aggregate per player across both innings with totals
            const aggregateTeam = (team, teamName) => {
                const a1 = (team && team.firstInnings) ? team.firstInnings : {};
                const a2 = (team && team.secondInnings) ? team.secondInnings : {};
                const batArr = [].concat(Array.isArray(a1.batting)?a1.batting:[], Array.isArray(a2.batting)?a2.batting:[]);
                const bowlArr = [].concat(Array.isArray(a1.bowling)?a1.bowling:[], Array.isArray(a2.bowling)?a2.bowling:[]);
                const map = new Map();
                const ensure = (name) => { if (!map.has(name)) map.set(name, { name, team: teamName, batRuns:0, batBalls:0, bowlWkts:0, bowlRuns:0, bowlOvers:0 }); return map.get(name); };
                batArr.forEach(p=>{ const name = p.name||p.player; if(!name) return; const e=ensure(name); e.batRuns += pick(p,['runs','r','score','runsScored']); e.batBalls += pick(p,['balls','b','bf']); });
                bowlArr.forEach(p=>{ const name = p.name||p.player; if(!name) return; const e=ensure(name); e.bowlWkts += pick(p,['wickets','wkts']); e.bowlRuns += pick(p,['runsConceded','runs']); e.bowlOvers += oversFrom(p); });
                return map;
            };
            const teamAName = fullScorecard.teamA?.name || 'Team A';
            const teamBName = fullScorecard.teamB?.name || 'Team B';
            const Amap = aggregateTeam(fullScorecard.teamA, teamAName);
            const Bmap = aggregateTeam(fullScorecard.teamB, teamBName);
            const all = [...Amap.values(), ...Bmap.values()];

            let best = null;
            const scoreOf = (p) => {
                // Batting
                const runs = p.batRuns;
                const balls = p.batBalls;
                const sr = balls>0 ? (runs/balls)*100 : 0;
                let batScore = runs; // base
                if (runs >= 50) batScore += 6; // milestone bonus
                if (runs >= 100) batScore += 12; // century bonus
                if (sr >= 130) batScore += 6; else if (sr >= 110) batScore += 3; // SR bonus

                // Bowling
                const wk = p.bowlWkts;
                const ov = p.bowlOvers;
                const rc = p.bowlRuns;
                let bowlScore = wk * 22; // base wicket weight
                if (wk >= 4) bowlScore += 8; // 4-fer
                if (wk >= 5) bowlScore += 16; // 5-fer
                if (ov > 0) {
                    const econ = rc / Math.max(ov, 0.1);
                    if (econ <= 4.5) bowlScore += 10; else if (econ <= 6.0) bowlScore += 6; else if (econ <= 7.5) bowlScore += 2;
                }

                // All-round bonus
                let ar = 0; if (runs >= 30 && wk >= 2) ar += 12; if (runs >= 50 && wk >= 3) ar += 10;

                return { total: batScore + bowlScore + ar, batScore, bowlScore, ar, runs, wk, sr: sr.toFixed(1) };
            };

            all.forEach(p=>{
                const sc = scoreOf(p);
                const cur = { ...p, ...sc };
                if (!best || cur.total > best.total) best = cur;
            });

            // Fallback: if no stats captured at all, try current live snapshots
            if (!best || best.total <= 0) {
                try {
                    const s = liveMatch?.currentBatsmen?.striker || {};
                    const ns = liveMatch?.currentBatsmen?.nonStriker || {};
                    const b = liveMatch?.currentBowler || {};
                    const cands = [];
                    if (s.name) cands.push({name:s.name, team: teamAName, runs: num(s.runs), wk:0, total: num(s.runs)});
                    if (ns.name) cands.push({name:ns.name, team: teamAName, runs: num(ns.runs), wk:0, total: num(ns.runs)});
                    if (b.name) cands.push({name:b.name, team: teamBName, runs:0, wk: num(b.wickets), total: num(b.wickets)*22});
                    cands.forEach(c=>{ if(!best || c.total>best.total) best=c; });
                } catch {}
            }

            if (!best) return null;
            const reason = (best.wk && best.wk>0)
                ? `${best.runs||0} runs, ${best.wk} wickets${best.sr? `, SR ${best.sr}`:''}`
                : `${best.runs||0} runs${best.sr? `, SR ${best.sr}`:''}`;
            return { name: best.name, team: best.team, reason };
        }

        // Show a simple banner + commentary for Man of the Match
        function displayManOfTheMatch(mom) {
            if (!mom || !mom.name) return;
            try { addCommentary(` Man of the Match: ${mom.name}`); } catch {}
            let el = document.getElementById('momBanner');
            if (!el) {
                el = document.createElement('div');
                el.id = 'momBanner';
                el.style.position = 'fixed';
                el.style.top = '16px';
                el.style.left = '50%';
                el.style.transform = 'translateX(-50%)';
                el.style.zIndex = '10000';
                el.style.background = '#064e3b';
                el.style.color = '#ecfdf5';
                el.style.padding = '10px 14px';
                el.style.borderRadius = '999px';
                el.style.boxShadow = '0 10px 24px rgba(2,6,23,.25)';
                el.style.fontWeight = '700';
                document.body.appendChild(el);
            }
            el.textContent = `Man of the Match: ${mom.name}`;
            // auto-hide after 8s
            clearTimeout(window.__momTimer);
            window.__momTimer = setTimeout(()=>{ try{ el.remove(); }catch{} }, 8000);
        }

        // Summary Modal (includes Man of the Match)
        function showDetailedMatchSummaryModal(summary) {
            try { const existing = document.getElementById('matchSummaryModal'); if (existing) existing.remove(); } catch {}
            const overlay = document.createElement('div');
            overlay.id = 'matchSummaryModal';
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(2,6,23,.65)';
            overlay.style.zIndex = '10000';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';

            const card = document.createElement('div');
            card.style.width = 'min(720px, 92vw)';
            card.style.background = '#0b1220';
            card.style.color = '#e2e8f0';
            card.style.borderRadius = '16px';
            card.style.boxShadow = '0 20px 40px rgba(2,6,23,.5)';
            card.style.padding = '20px 20px 16px';

            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.style.justifyContent = 'space-between';
            const title = document.createElement('div');
            title.style.fontWeight = '800';
            title.style.fontSize = '18px';
            title.textContent = 'Match Summary';
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.background = '#111827';
            closeBtn.style.color = '#e5e7eb';
            closeBtn.style.border = '1px solid #374151';
            closeBtn.style.padding = '6px 10px';
            closeBtn.style.borderRadius = '8px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = () => overlay.remove();
            header.appendChild(title);
            header.appendChild(closeBtn);

            const line = document.createElement('div');
            line.style.height = '1px';
            line.style.background = 'linear-gradient(90deg, transparent, #334155, transparent)';
            line.style.margin = '10px 0 12px';

            const resultRow = document.createElement('div');
            resultRow.style.fontSize = '16px';
            resultRow.style.marginBottom = '8px';
            resultRow.innerHTML = `<strong>Result:</strong> ${summary.result || '-'} <span style="opacity:.8">(${summary.status||''})</span>`;

            const momRow = document.createElement('div');
            momRow.style.fontSize = '16px';
            momRow.style.marginBottom = '8px';
            if (summary.manOfTheMatch && summary.manOfTheMatch.name) {
                momRow.innerHTML = `<strong>Man of the Match:</strong> ${summary.manOfTheMatch.name}`;
            } else {
                momRow.innerHTML = `<strong>Man of the Match:</strong> -`;
            }

            const metaRow = document.createElement('div');
            metaRow.style.fontSize = '12px';
            metaRow.style.opacity = '.85';
            metaRow.textContent = `Overs: ${summary.totalOvers || '-'}  Date: ${summary.matchDate||''} ${summary.matchTime||''}`;

            card.appendChild(header);
            card.appendChild(line);
            card.appendChild(resultRow);
            card.appendChild(momRow);
            card.appendChild(metaRow);

            overlay.appendChild(card);
            document.body.appendChild(overlay);
        }

        // Floating Live Scoreboard Box
        function ensureLiveScoreBox() {
            if (document.getElementById('liveScoreBox')) return;
            const box = document.createElement('div');
            box.id = 'liveScoreBox';
            box.style.position = 'fixed';
            box.style.right = '16px';
            box.style.bottom = '16px';
            box.style.zIndex = '9999';
            box.style.background = '#0b1220';
            box.style.color = '#e2e8f0';
            box.style.padding = '12px 14px';
            box.style.borderRadius = '12px';
            box.style.boxShadow = '0 10px 24px rgba(2,6,23,.35)';
            box.style.width = 'min(360px, 92vw)';
            box.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div id="lsbTeams" style="font-weight:800; color:#93c5fd;">-</div>
                    <div id="lsbStatus" style="font-size:12px; opacity:.9;">Live</div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
                    <div id="lsbScore" style="font-size:20px; font-weight:800;">0/0</div>
                    <div id="lsbOvers" style="font-size:12px;">Ov 0.0  RR 0.00</div>
                </div>
                <div id="lsbTarget" style="font-size:12px; margin-top:4px; opacity:.95;"></div>
                <div style="font-size:12px; margin-top:6px;">
                    <div id="lsbStrikers"></div>
                    <div id="lsbBowler"></div>
                </div>
            `;
            document.body.appendChild(box);
        }

        function updateLiveScoreBox() {
            const box = document.getElementById('liveScoreBox');
            if (!box || !liveMatch || !liveMatch.currentInnings) return;
            // Ensure a Match ID exists for linking scorer and tracker; persist for this session
            if (!window.matchId) {
                try {
                    const savedId = localStorage.getItem('cric_match_id_current');
                    window.matchId = savedId || generateMatchId();
                    localStorage.setItem('cric_match_id_current', window.matchId);
                    if (!savedId) { try { console.log('MATCH ID:', window.matchId); } catch {} }
                } catch (e) {
                    window.matchId = window.matchId || generateMatchId();
                }
            }
            // Ensure a match code exists and is persisted for this live session
            if (!window.matchCode) {
                try {
                    const saved = localStorage.getItem('cric_match_code_current');
                    window.matchCode = saved || generateMatchCode();
                    localStorage.setItem('cric_match_code_current', window.matchCode);
                } catch (e) {
                    window.matchCode = window.matchCode || generateMatchCode();
                }
            }
            const A = teamData?.teamA?.name || 'Team A';
            const B = teamData?.teamB?.name || 'Team B';
            const batting = liveMatch.currentInnings.batting === 'A' ? A : B;
            const bowling = liveMatch.currentInnings.bowling === 'A' ? A : B;
            const score = `${liveMatch.currentInnings.score||0}/${liveMatch.currentInnings.wickets||0}`;
            const overs = `${liveMatch.currentInnings.overs||0}.${liveMatch.currentInnings.balls||0}`;
            const totalBalls = (liveMatch.currentInnings.overs||0) * 6 + (liveMatch.currentInnings.balls||0);
            const rr = totalBalls>0 ? ((liveMatch.currentInnings.score||0)/totalBalls*6).toFixed(2) : '0.00';
            const s = liveMatch.currentBatsmen?.striker || {};
            const ns = liveMatch.currentBatsmen?.nonStriker || {};
            const b = liveMatch.currentBowler || {};

            const teamEl = document.getElementById('lsbTeams');
            const code = window.matchCode || '';
            if (code) {
                teamEl.innerHTML = `${A} vs ${B}  <span id="lsbCode">${code}</span> <button id="copyCodeBtn" style="margin-left:6px; padding:2px 6px; font-size:11px; border:1px solid #334155; border-radius:6px; background:#0f172a; color:#e5e7eb; cursor:pointer;">Copy</button>`;
                const btn = document.getElementById('copyCodeBtn');
                if (btn && navigator.clipboard) {
                    btn.onclick = () => { try { navigator.clipboard.writeText(code); btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy',1200); } catch {} };
                }
            } else {
                teamEl.textContent = `${A} vs ${B}`;
            }
            document.getElementById('lsbScore').textContent = score;
            document.getElementById('lsbOvers').textContent = `Ov ${overs}  RR ${rr}`;
            document.getElementById('lsbStrikers').textContent = `${s.name||'-'} ${s.runs||0}(${s.balls||0})  ${ns.name||'-'} ${ns.runs||0}(${ns.balls||0})`;
            const bowlerOv = (b.overs!==undefined) ? b.overs : (b.ballsBowled!==undefined ? `${Math.floor((b.ballsBowled||0)/6)}.${(b.ballsBowled||0)%6}` : '-');
            document.getElementById('lsbBowler').textContent = `Bowler: ${b.name||'-'} ${bowlerOv} ${b.maidens||0}m ${b.runs||0}-${b.wickets||0}`;

            // Target/Required (only for 2nd innings)
            const targetInfoEl = document.getElementById('lsbTarget');
            if (liveMatch.innings === 2 && typeof liveMatch.firstInningsScore === 'number') {
                const target = liveMatch.firstInningsScore + 1;
                const current = liveMatch.currentInnings.score||0;
                const ballsBowled = (liveMatch.currentInnings.overs||0) * 6 + (liveMatch.currentInnings.balls||0);
                const totalBalls = (matchConfig.overs||0) * 6;
                const ballsLeft = Math.max(0, totalBalls - ballsBowled);
                const runsNeeded = Math.max(0, target - current);
                const rrr = ballsLeft>0 ? ((runsNeeded/ballsLeft)*6).toFixed(2) : '0.00';
                targetInfoEl.textContent = `Target ${target}  Need ${runsNeeded} off ${ballsLeft} (RRR ${rrr})`;
            } else {
                targetInfoEl.textContent = '';
            }
            // Broadcast a safe live snapshot for viewer pages (cric-sco-trac.html)
            try { broadcastLiveState(); } catch(e) { /* noop */ }
        }

        // Broadcast a minimal, circular-safe snapshot of the live match to localStorage
        function broadcastLiveState(){
            if (typeof localStorage === 'undefined') return;
            const snapshot = {
                teamData: {
                    teamA: { name: teamData?.teamA?.name },
                    teamB: { name: teamData?.teamB?.name }
                },
                matchConfig: { overs: matchConfig?.overs },
                innings: liveMatch?.innings,
                firstInningsScore: liveMatch?.firstInningsScore,
                currentInnings: liveMatch?.currentInnings ? {
                    score: liveMatch.currentInnings.score,
                    wickets: liveMatch.currentInnings.wickets,
                    overs: liveMatch.currentInnings.overs,
                    balls: liveMatch.currentInnings.balls
                } : null,
                currentBatsmen: liveMatch?.currentBatsmen ? {
                    striker: {
                        name: liveMatch.currentBatsmen.striker?.name,
                        runs: liveMatch.currentBatsmen.striker?.runs,
                        balls: liveMatch.currentBatsmen.striker?.balls,
                        fours: liveMatch.currentBatsmen.striker?.fours,
                        sixes: liveMatch.currentBatsmen.striker?.sixes,
                        partnershipRuns: liveMatch.currentBatsmen.striker?.partnershipRuns,
                        partnershipBalls: liveMatch.currentBatsmen.striker?.partnershipBalls
                    },
                    nonStriker: {
                        name: liveMatch.currentBatsmen.nonStriker?.name,
                        runs: liveMatch.currentBatsmen.nonStriker?.runs,
                        balls: liveMatch.currentBatsmen.nonStriker?.balls,
                        fours: liveMatch.currentBatsmen.nonStriker?.fours,
                        sixes: liveMatch.currentBatsmen.nonStriker?.sixes,
                        partnershipRuns: liveMatch.currentBatsmen.nonStriker?.partnershipRuns,
                        partnershipBalls: liveMatch.currentBatsmen.nonStriker?.partnershipBalls
                    }
                } : null,
                currentBowler: liveMatch?.currentBowler ? {
                    name: liveMatch.currentBowler?.name,
                    overs: liveMatch.currentBowler?.overs,
                    ballsBowled: liveMatch.currentBowler?.ballsBowled,
                    maidens: liveMatch.currentBowler?.maidens,
                    runsConceded: liveMatch.currentBowler?.runsConceded ?? liveMatch.currentBowler?.runs,
                    wickets: liveMatch.currentBowler?.wickets
                } : null,
                recentDeliveriesLegal: liveMatch?.recentDeliveriesLegal || [],
                matchResult: liveMatch?.matchResult ? {
                    result: liveMatch.matchResult.result,
                    manOfTheMatch: liveMatch.matchResult.manOfTheMatch ? { name: liveMatch.matchResult.manOfTheMatch.name } : null
                } : null,
                matchCode: window.matchCode || null,
                matchId: window.matchId || null
            };
            try { localStorage.setItem('cric_live_state', JSON.stringify(snapshot)); } catch(e) { /* ignore quota/circular */ }
        }
        
        // Generates a short, human-friendly match code like 9K3C-X7
        function generateMatchCode(){
            const ts = Date.now().toString(36).toUpperCase();
            const rand = Math.random().toString(36).toUpperCase().slice(2,6);
            return `${ts.slice(-3)}${rand.slice(0,2)}-${rand.slice(2,4)}`;
        }
        
        // Generates MATCH-YYYYMMDD-HHMMSS-RRR where RRR is random 3 digits
        function generateMatchId(){
            const d = new Date();
            const pad = (n)=> String(n).padStart(2,'0');
            const yyyy = d.getFullYear();
            const MM = pad(d.getMonth()+1);
            const dd = pad(d.getDate());
            const hh = pad(d.getHours());
            const mm = pad(d.getMinutes());
            const ss = pad(d.getSeconds());
            const rand = Math.floor(Math.random()*900)+100; // 100-999
            return `MATCH-${yyyy}${MM}${dd}-${hh}${mm}${ss}-${rand}`;
        }
        
        // Initialize identifiers (matchCode now; matchId is assigned after toss)
        window.addEventListener('DOMContentLoaded', ()=>{
            try {
                // Ensure no pre-assigned matchId; it should be unique per match after toss
                window.matchId = null;
                // Match Code (optional, for human-friendly sharing)
                let mcode = localStorage.getItem('cric_match_code_current');
                if (!mcode) {
                    mcode = generateMatchCode();
                    localStorage.setItem('cric_match_code_current', mcode);
                }
                window.matchCode = mcode;
            } catch {}
        });

        // Assign unique Match ID only after toss selection is known
        function assignMatchIdAfterToss(){
            try {
                if (matchConfig && matchConfig.tossWinner && matchConfig.tossDecision) {
                    // Always generate a fresh ID when toss is finalized for a new match
                    const mid = generateMatchId();
                    window.matchId = mid;
                    try { localStorage.setItem('cric_match_id_current', mid); } catch(e) {}
                    try { console.log('Assigned Match ID after toss:', mid); } catch {}
                    updateMatchIdBanner();
                }
            } catch(e) {}
        }

        // Update the Match ID banner in the header
        function updateMatchIdBanner(){
            try {
                const el = document.getElementById('matchIdBanner');
                if (!el) return;
                if (window.matchId) {
                    el.textContent = `Match ID: ${window.matchId}`;
                    el.style.display = 'inline-block';
                } else {
                    el.textContent = '';
                    el.style.display = 'none';
                }
            } catch(e) {}
        }
        
        function getMatchEndExplanation(endReason) {
            switch(endReason) {
                case 'target_reached':
                    return `
                        <p style="color: #4CAF50; font-weight: bold;"> Target Reached!</p>
                        <p>The chasing team successfully reached the target score and won the match.</p>
                    `;
                case 'all_out':
                    return `
                        <p style="color: #FF6B35; font-weight: bold;"> All Out!</p>
                        <p>The batting team was dismissed before reaching the target or completing their overs.</p>
                    `;
                case 'overs_completed':
                    return `
                        <p style="color: #FF9800; font-weight: bold;"> Overs Completed!</p>
                        <p>The allocated overs were completed without the batting team reaching the target.</p>
                    `;
                case 'tie':
                    return `
                        <p style="color: #9C27B0; font-weight: bold;"> Match Tied!</p>
                        <p>Both teams scored exactly the same number of runs. What an exciting finish!</p>
                    `;
                case 'interrupted':
                    return `
                        <p style="color: #607D8B; font-weight: bold;"> Match Interrupted!</p>
                        <p>The match was stopped due to external factors (weather, light, etc.). No result declared.</p>
                    `;
                case 'first_innings_complete':
                    return `
                        <p style="color: #2196F3; font-weight: bold;"> First Innings Complete!</p>
                        <p>The first innings has been completed. Preparing for the second innings.</p>
                    `;
                default:
                    return `
                        <p style="color: #666; font-weight: bold;"> Match Completed!</p>
                        <p>The match has been completed according to cricket rules.</p>
                    `;
            }
        }

        function showDetailedMatchSummaryModal(summary) {
            // Create detailed match summary modal with full scorecards
            const modal = document.createElement('div');
            modal.id = 'matchSummaryModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
                    <h2> MATCH COMPLETED!</h2>
                    
                    <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                        <h3 style="margin: 0; font-size: 24px;">${summary.result}</h3>
                        <p style="margin: 10px 0 0 0; font-size: 16px;">Match completed on ${summary.matchDate} at ${summary.matchTime}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <h4> Match Summary</h4>
                            <p><strong>First Innings:</strong> ${summary.firstInnings} runs</p>
                            ${summary.secondInnings !== undefined ? `<p><strong>Second Innings:</strong> ${summary.secondInnings} runs</p>` : ''}
                            ${summary.target ? `<p><strong>Target:</strong> ${summary.target} runs</p>` : ''}
                            <p><strong>Overs per Innings:</strong> ${summary.totalOvers}</p>
                        </div>
                        
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <h4> Match End Details</h4>
                            ${getMatchEndExplanation(summary.endReason)}
                        </div>
                    </div>
                    
                    <div id="fullScorecardDisplay">
                        ${generateScorecardHTML(summary.fullScorecard)}
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeMatchSummaryModal()" style="padding: 12px 30px; background: #2196F3; color: white; border: none; border-radius: 6px; margin-right: 10px;">Close</button>
                        <button onclick="downloadScorecard()" style="padding: 12px 30px; background: #4CAF50; color: white; border: none; border-radius: 6px;"> Download Scorecard</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showSecondInningsSetupModal() {
            // Create comprehensive second innings setup modal
            const modal = document.createElement('div');
            modal.id = 'secondInningsModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const battingTeam = liveMatch.currentInnings.batting;
            const bowlingTeam = liveMatch.currentInnings.bowling;
            const target = liveMatch.firstInningsScore + 1;
            
            // Get team names safely
            const battingTeamName = battingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name;
            const bowlingTeamName = bowlingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name;
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <h2> Second Innings Setup</h2>
                    
                    <!-- Match Situation Summary -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #2196F3;">
                        <h3 style="margin-bottom: 15px; color: #1565C0;"> Match Situation</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong>First Innings Complete:</strong><br>
                                <span style="color: #FF6B35; font-size: 1.1em;">${bowlingTeamName}: ${liveMatch.firstInningsScore} runs</span>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong>Target for ${battingTeamName}:</strong><br>
                                <span style="color: #4CAF50; font-size: 1.2em; font-weight: bold;">${target} runs to win</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Team Role Explanation -->
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #FF9800;">
                        <h4 style="margin-bottom: 10px; color: #E65100;"> Second Innings Roles:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.95em;">
                            <div><strong> ${battingTeamName} (Team ${battingTeam})</strong><br>Now batting - chasing the target</div>
                            <div><strong> ${bowlingTeamName} (Team ${bowlingTeam})</strong><br>Now bowling - defending their score</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <!-- Batting Team Setup -->
                        <div style="border: 3px solid #4CAF50; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);">
                            <h3 style="color: #2E7D32; margin-bottom: 15px;"> ${battingTeamName} (Team ${battingTeam})</h3>
                            <div style="background: #4CAF50; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: bold;">
                                OPENING BATSMEN SELECTION
                            </div>
                            <p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">
                                <strong>Instructions:</strong> Select opening batsmen from ${battingTeamName}'s registered players<br>
                                 Choose Striker and Non-Striker to start the innings<br>
                                 Remaining players will be available for selection on wickets
                            </p>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                                <label style="font-weight: bold; color: #2E7D32; margin-bottom: 8px; display: block;"> Striker (On Strike):</label>
                                <select id="secondInningsStriker" style="width: 100%; padding: 10px; border: 2px solid #4CAF50; border-radius: 6px; font-size: 1em;">
                                    <option value="">Select ${battingTeamName} striker</option>
                                </select>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <label style="font-weight: bold; color: #2E7D32; margin-bottom: 8px; display: block;"> Non-Striker:</label>
                                <select id="secondInningsNonStriker" style="width: 100%; padding: 10px; border: 2px solid #4CAF50; border-radius: 6px; font-size: 1em;">
                                    <option value="">Select ${battingTeamName} non-striker</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bowling Team Setup -->
                        <div style="border: 3px solid #FF9800; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);">
                            <h3 style="color: #E65100; margin-bottom: 15px;"> ${bowlingTeamName} (Team ${bowlingTeam})</h3>
                            <div style="background: #FF9800; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; text-align: center; font-weight: bold;">
                                BOWLING LINEUP SETUP
                            </div>
                            <p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">
                                <strong>Instructions:</strong> Configure ${bowlingTeamName} bowling attack<br>
                                 Select opening bowler to start the innings<br>
                                 Choose available bowlers for rotation
                            </p>
                            
                            <div style="margin-bottom: 15px; background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <label style="font-weight: bold; color: #E65100; margin-bottom: 8px; display: block;"> Opening Bowler:</label>
                                <select id="secondInningsOpeningBowler" style="width: 100%; padding: 10px; border: 2px solid #FF9800; border-radius: 6px; font-size: 1em;">
                                    <option value="">Select ${bowlingTeamName} opening bowler</option>
                                </select>
                            </div>
                            
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd;">
                                <label style="font-weight: bold; color: #E65100; margin-bottom: 8px; display: block;"> Available Bowlers:</label>
                                <div id="secondInningsBowlingList" style="max-height: 220px; overflow-y: auto; padding: 8px; border: 1px solid #eee; border-radius: 4px; background: #fafafa;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 25px; padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
                        <div id="secondInningsValidation" style="margin-bottom: 15px; padding: 10px; border-radius: 6px; font-size: 0.95em; font-weight: 500;"></div>
                        <button type="button" onclick="validateAndStartSecondInnings()" id="startSecondInningsBtn" disabled 
                                style="padding: 15px 40px; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3); transition: all 0.3s ease;">
                             Start Second Innings
                        </button>
                        <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                            Ensure both teams have proper lineups before starting
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize the setup
            initializeSecondInningsSetup();
        }

        function updateBatsmanDropdowns() {
            const strikerSelect = document.getElementById('secondInningsStriker');
            const nonStrikerSelect = document.getElementById('secondInningsNonStriker');
            
            const strikerValue = strikerSelect.value;
            const nonStrikerValue = nonStrikerSelect.value;
            
            // Enable all options first
            Array.from(strikerSelect.options).forEach(option => {
                if (option.value) option.disabled = false;
            });
            Array.from(nonStrikerSelect.options).forEach(option => {
                if (option.value) option.disabled = false;
            });
            
            // Disable selected options in the other dropdown
            if (strikerValue) {
                Array.from(nonStrikerSelect.options).forEach(option => {
                    if (option.value === strikerValue) option.disabled = true;
                });
            }
            
            if (nonStrikerValue) {
                Array.from(strikerSelect.options).forEach(option => {
                    if (option.value === nonStrikerValue) option.disabled = true;
                });
            }
        }

        function initializeSecondInningsSetup() {
            const battingTeam = liveMatch.currentInnings.batting;
            const bowlingTeam = liveMatch.currentInnings.bowling;
            
            // Get team data safely
            const battingTeamData = battingTeam === 'A' ? teamData.teamA : teamData.teamB;
            const bowlingTeamData = bowlingTeam === 'A' ? teamData.teamA : teamData.teamB;
            
            // Initialize batting setup - populate striker and non-striker dropdowns
            const strikerSelect = document.getElementById('secondInningsStriker');
            const nonStrikerSelect = document.getElementById('secondInningsNonStriker');
            
            // Clear previous options to ensure correct team batsmen are shown
            strikerSelect.innerHTML = `<option value="">Select ${battingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name} striker</option>`;
            nonStrikerSelect.innerHTML = `<option value="">Select ${battingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name} non-striker</option>`;
            
            // Populate batting dropdowns with correct batting team players (Team B in second innings)
            battingTeamData.players.forEach(player => {
                // Add to striker dropdown
                const strikerOption = document.createElement('option');
                strikerOption.value = player.name;
                strikerOption.textContent = player.name;
                strikerSelect.appendChild(strikerOption);
                
                // Add to non-striker dropdown
                const nonStrikerOption = document.createElement('option');
                nonStrikerOption.value = player.name;
                nonStrikerOption.textContent = player.name;
                nonStrikerSelect.appendChild(nonStrikerOption);
            });
            
            // Add change event listeners to prevent duplicate selection
            strikerSelect.addEventListener('change', function() {
                updateBatsmanDropdowns();
                validateSecondInningsSetup();
            });
            
            nonStrikerSelect.addEventListener('change', function() {
                updateBatsmanDropdowns();
                validateSecondInningsSetup();
            });
            
            // Initialize bowling setup
            const openingBowlerSelect = document.getElementById('secondInningsOpeningBowler');
            const bowlingListDiv = document.getElementById('secondInningsBowlingList');
            
            // Clear previous options to ensure correct team bowlers are shown
            openingBowlerSelect.innerHTML = `<option value="">Select ${bowlingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name} opening bowler</option>`;
            bowlingListDiv.innerHTML = '';
            
            // Populate with correct bowling team players (Team A in second innings)
            bowlingTeamData.players.forEach(player => {
                // Add to opening bowler dropdown
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = player.name;
                openingBowlerSelect.appendChild(option);
                
                // Add to available bowlers list
                const bowlerDiv = document.createElement('div');
                bowlerDiv.innerHTML = `
                    <label style="display: flex; align-items: center; margin-bottom: 5px;">
                        <input type="checkbox" value="${player.name}" checked style="margin-right: 8px;">
                        ${player.name}
                    </label>
                `;
                bowlingListDiv.appendChild(bowlerDiv);
            });
            
            validateSecondInningsSetup();
        }







        function validateSecondInningsSetup() {
            const strikerSelect = document.getElementById('secondInningsStriker');
            const nonStrikerSelect = document.getElementById('secondInningsNonStriker');
            const openingBowlerSelect = document.getElementById('secondInningsOpeningBowler');
            const bowlingCheckboxes = document.querySelectorAll('#secondInningsBowlingList input[type=\"checkbox\"]:checked');
            const validationDiv = document.getElementById('secondInningsValidation');
            const startBtn = document.getElementById('startSecondInningsBtn');
            
            // Get team information for better feedback
            const battingTeam = liveMatch.currentInnings.batting;
            const bowlingTeam = liveMatch.currentInnings.bowling;
            const battingTeamName = battingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name;
            const bowlingTeamName = bowlingTeam === 'A' ? teamData.teamA.name : teamData.teamB.name;
            
            let isValid = true;
            let errors = [];
            let warnings = [];
            
            // Validate batting setup
            if (!strikerSelect.value) {
                errors.push(` Select striker from ${battingTeamName} registered players`);
                isValid = false;
            } else {
                warnings.push(` ${battingTeamName} striker: ${strikerSelect.value}`);
            }
            
            if (!nonStrikerSelect.value) {
                errors.push(` Select non-striker from ${battingTeamName} registered players`);
                isValid = false;
            } else {
                warnings.push(` ${battingTeamName} non-striker: ${nonStrikerSelect.value}`);
            }
            
            if (strikerSelect.value && nonStrikerSelect.value && strikerSelect.value === nonStrikerSelect.value) {
                errors.push(` Striker and non-striker cannot be the same player`);
                isValid = false;
            }
            
            // Validate bowling setup
            if (!openingBowlerSelect.value) {
                errors.push(` Select opening bowler from ${bowlingTeamName}`);
                isValid = false;
            } else {
                warnings.push(` ${bowlingTeamName} opening bowler: ${openingBowlerSelect.value}`);
            }
            
            if (bowlingCheckboxes.length < 5) {
                errors.push(` ${bowlingTeamName} needs at least 5 available bowlers (currently ${bowlingCheckboxes.length})`);
                isValid = false;
            } else {
                warnings.push(` ${bowlingTeamName} bowling options: ${bowlingCheckboxes.length} bowlers available`);
            }
            
            // Update UI with enhanced feedback
            if (errors.length > 0) {
                validationDiv.innerHTML = `
                    <div style="background: #ffebee; border: 1px solid #f44336; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                        <strong style="color: #d32f2f;"> Setup Required:</strong><br>
                        ${errors.join('<br>')}
                    </div>
                `;
                validationDiv.style.color = '#d32f2f';
            } else if (warnings.length > 0) {
                validationDiv.innerHTML = `
                    <div style="background: #e8f5e8; border: 1px solid #4CAF50; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                        <strong style="color: #2E7D32;"> Setup Complete:</strong><br>
                        ${warnings.join('<br>')}
                    </div>
                `;
                validationDiv.style.color = '#2E7D32';
            } else {
                validationDiv.innerHTML = '';
            }
            
            startBtn.disabled = !isValid;
            startBtn.style.background = isValid ? '#2196F3' : '#ccc';
            startBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
            startBtn.style.opacity = isValid ? '1' : '0.6';
        }

        function validateAndStartSecondInnings() {
            const strikerSelect = document.getElementById('secondInningsStriker');
            const nonStrikerSelect = document.getElementById('secondInningsNonStriker');
            const openingBowlerSelect = document.getElementById('secondInningsOpeningBowler');
            const bowlingCheckboxes = document.querySelectorAll('#secondInningsBowlingList input[type=\"checkbox\"]:checked');
            
            // Get selected players
            const striker = strikerSelect.value;
            const nonStriker = nonStrikerSelect.value;
            const openingBowler = openingBowlerSelect.value;
            
            // Get bowling lineup
            const availableBowlers = Array.from(bowlingCheckboxes).map(cb => cb.value);
            
            // Get team data for available players list
            const battingTeam = liveMatch.currentInnings.batting;
            const battingTeamData = battingTeam === 'A' ? teamData.teamA : teamData.teamB;
            
            // Initialize second innings player stats for all registered players
            battingTeamData.players.forEach(player => {
                liveMatch.secondInningsPlayerStats[player.name] = {
                    name: player.name,
                    runs: 0,
                    balls: 0,
                    fours: 0,
                    sixes: 0,
                    strikeRate: 0,
                    isOut: false,
                    howOut: '',
                    team: liveMatch.currentInnings.batting
                };
            });
            
            // Initialize second innings bowling stats
            availableBowlers.forEach(bowlerName => {
                liveMatch.secondInningsBowlerStats[bowlerName] = {
                    name: bowlerName,
                    overs: 0,
                    balls: 0,
                    runs: 0,
                    wickets: 0,
                    maidens: 0,
                    economy: 0,
                    team: liveMatch.currentInnings.bowling
                };
            });
            
            // Set up current batsmen and bowler with selected players
            liveMatch.currentBatsmen = {
                striker: {
                    name: striker,
                    runs: 0, balls: 0, fours: 0, sixes: 0
                },
                nonStriker: {
                    name: nonStriker,
                    runs: 0, balls: 0, fours: 0, sixes: 0
                }
            };
            
            liveMatch.currentBowler = {
                name: openingBowler,
                overs: 0, balls: 0, runs: 0, wickets: 0, maidens: 0
            };
            
            // Store available players and bowlers for future selection
            liveMatch.availableBatsmen = battingTeamData.players
                .map(p => p.name)
                .filter(name => name !== striker && name !== nonStriker);
            liveMatch.availableBowlers = availableBowlers;
            
            // Track bowler over limits (max overs per bowler = total overs / 5)
            liveMatch.maxOversPerBowler = Math.ceil(matchConfig.overs / 5);
            liveMatch.bowlerOverCounts = {};
            availableBowlers.forEach(bowler => {
                liveMatch.bowlerOverCounts[bowler] = 0;
            });
            
            // Close modal and start second innings
            document.getElementById('secondInningsModal').remove();
            
            // Activate match
            liveMatch.isMatchActive = true;
            
            // Update displays
            updateAllDisplays();
            
            addCommentary(` Second innings begins! ${liveMatch.currentBatsmen.striker.name} and ${liveMatch.currentBatsmen.nonStriker.name} are at the crease.`);
            addCommentary(`${liveMatch.currentBowler.name} will open the bowling.`);
        }

        function validateMatchConfiguration() {
            // Validate overs
            if (!matchConfig.overs || matchConfig.overs < 1 || matchConfig.overs > 50) {
                showConfigMessage('Please enter valid number of overs (1-50)', 'error');
                return false;
            }

            // Validate toss
            if (!matchConfig.tossWinner || !matchConfig.tossDecision) {
                showConfigMessage('Please complete toss configuration', 'error');
                return false;
            }

            // Validate players
            if (!matchConfig.striker || !matchConfig.nonStriker || !matchConfig.openingBowler) {
                showConfigMessage('Please select all opening players', 'error');
                return false;
            }

            // Validate different batsmen
            if (matchConfig.striker === matchConfig.nonStriker) {
                showConfigMessage('Striker and non-striker must be different players', 'error');
                return false;
            }

            return true;
        }

        function updateProgressIndicator(activePhase) {
            // This function would update a progress indicator if we had one
            // For now, we can add this functionality later
        }

        function showConfigMessage(message, type) {
            const validationMessage = document.getElementById('configValidationMessage');
            const successMessage = document.getElementById('configSuccessMessage');
            
            validationMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            if (type === 'error') {
                validationMessage.textContent = message;
                validationMessage.style.display = 'block';
                setTimeout(() => validationMessage.style.display = 'none', 5000);
            } else {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                setTimeout(() => successMessage.style.display = 'none', 3000);
            }
        }

        function resetTeams() {
            teamData = {
                teamA: { name: '', players: [] },
                teamB: { name: '', players: [] }
            };
            
            // Clear all inputs
            document.getElementById('teamAName').value = '';
            document.getElementById('teamBName').value = '';
            document.getElementById('teamAPlayers').innerHTML = '';
            document.getElementById('teamBPlayers').innerHTML = '';
            
            // Reset match data
            if (liveMatch) {
                liveMatch.scorecards = {
                    teamA: {
                        firstInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } },
                        secondInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } }
                    },
                    teamB: {
                        firstInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } },
                        secondInnings: { batting: [], bowling: [], score: 0, wickets: 0, overs: 0, extras: { wides: 0, noballs: 0, byes: 0, legbyes: 0 } }
                    }
                };
                liveMatch.secondInningsPlayerStats = {};
                liveMatch.secondInningsBowlerStats = {};
            }
            
            updateTeamCounts();
        }

        function showMessage(message, type) {
            const validationMessage = document.getElementById('validationMessage');
            const successMessage = document.getElementById('successMessage');
            
            validationMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            if (type === 'error') {
                validationMessage.textContent = message;
                validationMessage.style.display = 'block';
                setTimeout(() => validationMessage.style.display = 'none', 5000);
            } else {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                setTimeout(() => successMessage.style.display = 'none', 3000);
            }
        }
    </script>

    <!-- Bowler Change Modal -->
    <div id="bowlerChangeModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; padding: 20px;">
            <h3>Select Next Bowler</h3>
            <p>Please select the next bowler for the upcoming over.</p>
            
            <div style="margin: 20px 0;">
                <label for="newBowler" style="display: block; margin-bottom: 8px; font-weight: 500;">Select Bowler:</label>
                <select id="newBowler" class="form-control" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="">Select new bowler</option>
                </select>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button onclick="closeBowlerChangeModal()" class="btn btn-secondary" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="confirmBowlerChange()" class="btn btn-primary" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Confirm Bowler
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .form-control {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .form-control:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
</body>
</html>